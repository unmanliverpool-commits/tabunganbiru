<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabungan Siswa Digital</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Poppins", sans-serif;
      background: #f4f9ff;
    }

    /* ===== SPLASH SCREEN ===== */
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #4facfe, #00c6ff); /* üåà biru langit */
      background-size: 300% 300%;
      animation: gradientMove 6s ease infinite;
      color: white;
      text-align: center;
      z-index: 9999;
      transition: opacity 0.8s ease, visibility 0.8s ease;
    }
    #splash.fade-out {
      opacity: 0;
      visibility: hidden;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #splash img {
      width: 140px;
      height: 140px;
      margin-bottom: 25px;
      opacity: 0;
      transform: scale(0.7);
      animation: fadeInScale 1.5s ease forwards;
      filter: drop-shadow(0px 4px 8px rgba(0,0,0,0.3));
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.7); }
      to { opacity: 1; transform: scale(1); }
    }

    .app-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      opacity: 0;
      animation: fadeIn 1.5s ease forwards 0.5s;
      text-shadow: 0 0 8px rgba(255,255,255,0.6);
    }
    .subtitle {
      font-size: 17px;
      font-weight: 400;
      margin-bottom: 35px;
      opacity: 0;
      animation: fadeIn 1.5s ease forwards 1s;
      color: #e3f7ff;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-bar {
      width: 150px;
      height: 8px;
      background: rgba(255,255,255,0.25);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.2) inset;
    }
    .loading-bar::after {
      content: "";
      position: absolute;
      top: 0; left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(to right, #fff, #ccf5ff);
      border-radius: 10px;
      animation: loading 2s infinite;
    }
    @keyframes loading {
      0% { left: -40%; }
      50% { left: 100%; }
      100% { left: -40%; }
    }

    /* ===== KONTEN UTAMA ===== */
    #main-app {
      display: none;
      padding: 20px;
      text-align: center;
      animation: fadeIn 1s ease forwards;
    }
    #main-app h1 {
      color: #007acc; /* biru utama */
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <img src="img/logo.png" alt="Logo Sekolah">
    <div class="app-title">TABUNGAN SISWA DIGITAL</div>
    <div class="subtitle">Sistem Rekap Tabungan Siswa</div>
    <div class="loading-bar"></div>
  </div>

  <!-- Konten Utama -->
    <!-- Suara Intro -->
  <audio id="splash-sound" src="sound/intro.mp3" preload="auto"></audio>

  <script>
    window.addEventListener("load", function() {
      const audio = document.getElementById("splash-sound");
      audio.play().catch(() => {
        console.warn("Autoplay dicegah browser, klik layar untuk memulai suara.");
        document.body.addEventListener("click", () => audio.play(), { once: true });
      });

      // Splash hilang setelah 5 detik
      setTimeout(() => {
        document.getElementById("splash").classList.add("fade-out");
        setTimeout(() => {
          document.getElementById("splash").style.display = "none";
          document.getElementById("main-app").style.display = "block";
          audio.pause();
          audio.currentTime = 0;
        }, 800);
      }, 5000);
    });
  </script>
</body>
</html>

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabungan Siswa Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .tab-content { 
            display: none; 
            animation: fadeInUp 0.5s ease-out;
        }
        .tab-content.active { 
            display: block; 
        }
        
        .tab-button {
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .tab-button.active { 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #ffffff;
            border-bottom: 4px solid #0369a1;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.4);
            transform: translateY(-2px);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .btn-mobile {
            min-height: 48px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 16px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            touch-action: manipulation;
        }
        
        .btn-mobile:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .card-mobile {
            background: linear-gradient(145deg, #fafbfc, #f5f7fa);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            padding: 24px;
            border: 1px solid rgba(209, 231, 221, 0.3);
            transition: all 0.3s ease;
        }
        
        .card-mobile:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 20px;
            padding: 20px;
            color: #2d5a3d;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            border: 1px solid rgba(45, 90, 61, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 30px rgba(45, 90, 61, 0.15);
        }
        
        .stat-card:nth-child(1) { 
            background: linear-gradient(135deg, #e8f2f7 0%, #f0f7fa 100%);
            color: #2c5282;
        }
        .stat-card:nth-child(2) { 
            background: linear-gradient(135deg, #f7e8f2 0%, #faf0f7 100%);
            color: #822c5a;
        }
        .stat-card:nth-child(3) { 
            background: linear-gradient(135deg, #e8f7f2 0%, #f0faf7 100%);
            color: #2c8252;
        }
        .stat-card:nth-child(4) { 
            background: linear-gradient(135deg, #f7f2e8 0%, #faf7f0 100%);
            color: #82522c;
        }
        
        .table-container {
            max-height: 60vh;
            overflow: auto;
            border-radius: 16px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .gradient-header {
            background: linear-gradient(135deg, #87CEEB 0%, #87CEFA 50%, #B0E0E6 100%);
            background-size: 300% 300%;
            position: relative;
            overflow: hidden;
        }
        
        .cool-input {
            background: linear-gradient(145deg, #fafbfc, #f5f7fa);
            border: 2px solid #e2e8f0;
            background-clip: padding-box;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .cool-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(45, 90, 61, 0.15);
            border-color: #81c784;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(10px);
            background: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background: linear-gradient(145deg, #fafbfc, #f5f7fa);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
    <div class="w-full max-w-md mx-auto bg-white min-h-screen shadow-2xl">
        <!-- Header -->
        <div class="gradient-header p-6 text-white shadow-2xl">
            <div class="text-center relative z-10">
                <div class="mb-3">
                    <div class="inline-block p-3 bg-white bg-opacity-20 rounded-full backdrop-blur-sm">
                        <span class="text-3xl animate-bounce">üè¶</span>
                    </div>
                </div>
                <h1 class="text-2xl font-bold tracking-wide mb-2 drop-shadow-lg">SISTEM TABUNGAN SISWA</h1>
                
                <!-- Autosave Notification & Sound Toggle -->
                <div class="flex items-center justify-center gap-4">
                    <!-- Autosave Notification -->
                    <div id="autosaveNotif" class="opacity-100 transition-all duration-500 transform">
                        <div class="inline-flex items-center gap-2 bg-white bg-opacity-30 rounded-full px-3 py-1 text-xs backdrop-blur-md border border-white border-opacity-40 shadow-lg">
                            <div id="saveIcon" class="text-sm">üíæ</div>
                            <span id="saveText" class="font-medium text-gray-700">AUTO SAVE</span>
                            <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    
                    <!-- Sound Toggle Button -->
                    <button id="soundToggle" onclick="toggleSound()" class="bg-white bg-opacity-30 hover:bg-opacity-50 rounded-full p-1.5 backdrop-blur-md border border-white border-opacity-40 shadow-lg transition-all duration-200 hover:scale-105" title="Toggle Sound Effects">
                        <span id="soundIcon" class="text-sm">üîä</span>
                    </button>
                </div>
            </div>
            
            <!-- Floating particles effect -->
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                <div class="absolute top-10 left-10 w-2 h-2 bg-white opacity-30 rounded-full animate-float"></div>
                <div class="absolute top-20 right-16 w-1 h-1 bg-white opacity-40 rounded-full animate-float" style="animation-delay: 1s;"></div>
                <div class="absolute bottom-10 left-20 w-3 h-3 bg-white opacity-20 rounded-full animate-float" style="animation-delay: 2s;"></div>
                <div class="absolute bottom-16 right-10 w-1 h-1 bg-white opacity-50 rounded-full animate-float" style="animation-delay: 0.5s;"></div>
            </div>
        </div>

        <!-- Compact Header (shown when main header is hidden) -->
        <div id="compactHeader" class="bg-gradient-to-r from-gray-300 to-gray-400 text-gray-700 text-center py-3 shadow-lg hidden">
            <div class="flex items-center justify-center gap-3">
                <h2 class="text-lg font-bold tracking-wide">TABUNGAN SISWA</h2>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex bg-gradient-to-r from-sky-100 to-blue-100 shadow-lg border-t border-sky-200 sticky top-0 z-20 overflow-x-auto">
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 active flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('dashboard')">
                <span class="text-lg">‚≠ê</span>
                <span class="text-xs font-medium text-white">DASHBOARD</span>
            </button>
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('siswa')">
                <span class="text-lg">üë•</span>
                <span class="text-xs font-medium text-white">SISWA</span>
            </button>
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('transaksi')">
                <span class="text-lg">üí∏</span>
                <span class="text-xs font-medium text-white">TRANSAKSI</span>
            </button>
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('riwayat')">
                <span class="text-lg">üìã</span>
                <span class="text-xs font-medium text-white">RIWAYAT</span>
            </button>
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('rekap')">
                <span class="text-lg">üìä</span>
                <span class="text-xs font-medium text-white">REKAP</span>
            </button>
            <button class="tab-button flex-1 py-4 px-2 border-b-3 border-transparent hover:bg-sky-200 flex flex-col items-center gap-1 transition-all duration-200 min-w-0" onclick="showTab('unduh')">
                <span class="text-lg">üì•</span>
                <span class="text-xs font-medium text-white">UNDUH</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 p-4">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="space-y-4">
                    <!-- Real-time Clock -->
                    <div class="bg-gradient-to-r from-sky-300 to-blue-400 text-white rounded-lg p-4 text-center shadow-lg">
                        <div class="text-lg font-bold" id="waktuLengkap">-</div>
                    </div>

                    <!-- School Info -->
                    <div class="card-mobile py-3">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                <span class="text-lg">üè´</span>
                                INFORMASI SEKOLAH
                            </h2>
                            <button onclick="showEditSekolahModal()" class="w-8 h-8 bg-gray-400 hover:bg-gray-500 text-white rounded-lg shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-105">
                                ‚úèÔ∏è
                            </button>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs text-gray-600 font-medium mb-1">NAMA SEKOLAH</label>
                                <input type="text" id="namaSekolah" class="cool-input w-full border border-gray-300 bg-gray-100 text-gray-700 rounded-lg p-2 shadow-sm cursor-not-allowed text-xs" placeholder="Klik tombol edit untuk mengisi" readonly>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-600 font-medium mb-1">KELAS</label>
                                    <input type="text" id="kelas" class="cool-input w-full border border-gray-300 bg-gray-100 text-gray-700 rounded-lg p-2 shadow-sm cursor-not-allowed text-xs" placeholder="Klik edit" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 font-medium mb-1">WALI KELAS</label>
                                    <input type="text" id="waliKelas" class="cool-input w-full border border-gray-300 bg-gray-100 text-gray-700 rounded-lg p-2 shadow-sm cursor-not-allowed text-xs" placeholder="Klik edit" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card">
                            <div class="relative z-10">
                                <div class="text-4xl mb-2">üí∞</div>
                                <div class="text-xs opacity-80 mb-2 font-medium">TOTAL SALDO</div>
                                <div id="totalSaldo" class="text-lg font-bold drop-shadow-lg">Rp 0</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="relative z-10">
                                <div class="text-4xl mb-2">üë•</div>
                                <div class="text-xs opacity-80 mb-2 font-medium">JUMLAH SISWA</div>
                                <div id="jumlahSiswa" class="text-sm font-bold leading-tight drop-shadow-lg">
                                    <div>0 L / 0 SISWA</div>
                                    <div>0 P / 0 SISWA</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="relative z-10">
                                <div class="text-4xl mb-2">üìä</div>
                                <div class="text-xs opacity-80 mb-2 font-medium">TABUNGAN HARI INI</div>
                                <div id="tabunganHariIni" class="text-sm font-bold leading-tight drop-shadow-lg">
                                    <div>SETOR: Rp 0</div>
                                    <div>TARIK: Rp 0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="relative z-10">
                                <div class="text-4xl mb-2">‚≠ê</div>
                                <div class="text-xs opacity-80 mb-2 font-medium">SISWA AKTIF</div>
                                <div id="siswaAktif" class="text-lg font-bold drop-shadow-lg">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Students -->
                    <div class="card-mobile">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <span class="text-xl">üèÜ</span>
                            5 SISWA TABUNGAN TERTINGGI
                        </h3>
                        <div id="topSaldo" class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Belum ada data</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Siswa Tab -->
            <div id="siswa" class="tab-content">
                <div class="space-y-4">
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-gray-700 flex items-center justify-center gap-2">
                            <span class="text-lg">üë•</span>
                            DATA SISWA
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="uploadData()" class="btn-mobile bg-gradient-to-r from-orange-300 to-orange-400 hover:from-orange-400 hover:to-orange-500 text-white shadow-lg border-2 border-orange-200 text-sm">
                            üì§ UPLOAD EXCEL
                        </button>
                        <button onclick="tambahSiswa()" class="btn-mobile bg-gradient-to-r from-sky-400 to-blue-500 hover:from-sky-500 hover:to-blue-600 text-white shadow-lg border-2 border-sky-300 text-sm">
                            + TAMBAH SISWA
                        </button>
                    </div>
                    

                    
                    <!-- Tabel Siswa -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                        <div class="bg-gradient-to-r from-sky-400 via-blue-500 to-sky-600 p-4">
                            <h3 class="text-white font-bold text-lg flex items-center gap-3">
                                <span class="text-2xl">üìã</span>
                                DAFTAR SISWA TERDAFTAR
                            </h3>
                            <p class="text-sky-100 text-sm mt-1">Kelola data siswa dan saldo tabungan</p>
                        </div>
                        
                        <div class="table-container max-h-96 overflow-y-auto">
                            <table class="w-full">
                                <thead class="bg-gradient-to-r from-sky-50 to-blue-100 sticky top-0 border-b-2 border-sky-200">
                                    <tr>
                                        <th class="text-xs font-bold text-gray-700 text-center py-4 px-3 border-r border-gray-200">NO</th>
                                        <th class="text-xs font-bold text-gray-700 text-left py-4 px-4 border-r border-gray-200">NAMA SISWA</th>
                                        <th class="text-xs font-bold text-gray-700 text-center py-4 px-3 border-r border-gray-200">KELAS</th>
                                        <th class="text-xs font-bold text-gray-700 text-center py-4 px-3 border-r border-gray-200">GENDER</th>
                                        <th class="text-xs font-bold text-gray-700 text-right py-4 px-4 border-r border-gray-200">SALDO TABUNGAN</th>
                                        <th class="text-xs font-bold text-gray-700 text-center py-4 px-3">AKSI</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelSiswa">
                                    <tr>
                                        <td colspan="6" class="text-center text-gray-500 py-12 text-sm">
                                            <div class="flex flex-col items-center gap-3">
                                                <span class="text-4xl">üë•</span>
                                                <span class="font-medium">Belum ada siswa terdaftar</span>
                                                <span class="text-xs text-gray-400">Klik tombol "TAMBAH SISWA" untuk menambah siswa baru</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaksi Tab -->
            <div id="transaksi" class="tab-content">
                <div class="space-y-4">
                    <!-- Button to open transaction form -->
                    <button onclick="bukaFormTransaksi()" class="btn-mobile w-full bg-gradient-to-r from-sky-300 to-blue-400 hover:from-sky-400 hover:to-blue-500 text-white shadow-lg border-2 border-sky-200 text-sm py-3">
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-lg">üí∞</span>
                            <span class="font-bold">BUAT TRANSAKSI BARU</span>
                        </div>
                    </button>

                    <!-- Info Tanggal -->
                    <div id="infoTanggal" class="text-center text-sky-700 font-medium text-sm bg-sky-50 p-3 rounded-lg"></div>

                    <!-- Transaction Table -->
                    <div class="card-mobile">
                        <h4 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <span class="text-xl">üìä</span>
                            TRANSAKSI HARI INI
                        </h4>
                        <div class="table-container">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-sky-300 to-blue-400 text-white sticky top-0">
                                    <tr>
                                        <th class="text-xs font-medium text-left py-3">NAMA</th>
                                        <th class="text-xs font-medium text-center py-3">SETOR</th>
                                        <th class="text-xs font-medium text-center py-3">TARIK</th>
                                        <th class="text-xs font-medium text-right py-3">SALDO</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelTransaksi">
                                    <tr>
                                        <td colspan="4" class="text-center text-gray-500 py-8 text-sm">
                                            BELUM ADA TRANSAKSI HARI INI
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riwayat Tab -->
            <div id="riwayat" class="tab-content">
                <div class="space-y-4">
                    <!-- Filter Section -->
                    <div class="card-mobile">
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">BULAN</label>
                                <select id="filterBulan" class="w-full p-2 border border-sky-200 rounded-lg focus:border-sky-400 outline-none text-xs">
                                    <option value="1">JAN</option>
                                    <option value="2">FEB</option>
                                    <option value="3">MAR</option>
                                    <option value="4">APR</option>
                                    <option value="5">MEI</option>
                                    <option value="6">JUN</option>
                                    <option value="7">JUL</option>
                                    <option value="8">AGU</option>
                                    <option value="9">SEP</option>
                                    <option value="10">OKT</option>
                                    <option value="11">NOV</option>
                                    <option value="12">DES</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">TAHUN</label>
                                <select id="filterTahun" class="w-full p-2 border border-sky-200 rounded-lg focus:border-sky-400 outline-none text-xs">
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <button onclick="updateRiwayatTabel()" class="btn-mobile bg-sky-400 hover:bg-sky-500 text-white shadow-lg w-full text-xs px-1 py-1.5">
                                    üîç LIHAT
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Info Bulan -->
                    <div id="infoBulanRiwayat" class="text-center text-sky-800 font-bold text-lg bg-sky-50 p-3 rounded-lg"></div>

                    <!-- Tabel Riwayat -->
                    <div class="card-mobile">
                        <!-- Navigation Controls -->
                        <div id="riwayatNavigation" class="mb-4 hidden">
                            <div class="flex items-center justify-between bg-gradient-to-r from-indigo-100 to-purple-100 p-3 rounded-lg border border-indigo-200">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-indigo-800">üìç NAVIGASI SISWA:</span>
                                    <span id="currentStudentRange" class="text-sm text-indigo-600 bg-white px-2 py-1 rounded font-medium">-</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="prevStudents" onclick="navigateStudents('prev')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold shadow disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200">
                                        ‚¨ÖÔ∏è SEBELUMNYA
                                    </button>
                                    <button id="nextStudents" onclick="navigateStudents('next')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold shadow disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200">
                                        SELANJUTNYA ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Jump -->
                            <div class="mt-2 flex items-center gap-2 text-xs">
                                <span class="text-gray-600 font-medium">üöÄ LOMPAT KE:</span>
                                <select id="jumpToStudent" onchange="jumpToStudent()" class="border border-indigo-200 rounded px-2 py-1 text-xs bg-white focus:border-indigo-500 outline-none">
                                    <option value="">-- Pilih Siswa --</option>
                                </select>
                                <button onclick="scrollToTop()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    ‚¨ÜÔ∏è ATAS
                                </button>
                                <button onclick="scrollToBottom()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold">
                                    ‚¨áÔ∏è BAWAH
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto border rounded-lg relative" style="max-height: 70vh;">
                            <!-- Horizontal scroll indicator -->
                            <div id="scrollIndicator" class="hidden bg-yellow-100 border-b border-yellow-300 p-2 text-center text-xs text-yellow-800 font-medium sticky top-0 z-20">
                                üí° Geser ke kanan untuk melihat tanggal lainnya ‚Üí
                            </div>
                            
                            <table class="w-full text-xs">
                                <thead class="bg-gradient-to-r from-purple-500 to-blue-600 text-white sticky top-0 z-15">
                                    <tr id="headerRiwayat">
                                        <th class="px-2 py-3 text-center font-medium border-r border-purple-400 sticky left-0 bg-purple-500 z-20">NO</th>
                                        <th class="px-3 py-3 text-left font-medium border-r border-purple-400 sticky left-12 bg-purple-500 z-20" style="left: 48px;">NAMA SISWA</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelRiwayat">
                                    <tr>
                                        <td colspan="2" class="text-center text-gray-500 py-8 text-sm">
                                            PILIH BULAN DAN TAHUN UNTUK MELIHAT RIWAYAT
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Scroll to student controls -->
                        <div id="studentScrollControls" class="mt-3 hidden">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-3 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-blue-700">
                                        <span class="font-bold">üìä TOTAL:</span> 
                                        <span id="totalStudentsCount">0</span> siswa
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-blue-600 font-medium">SCROLL KE SISWA:</span>
                                        <input type="number" id="scrollToStudentNumber" min="1" max="1" placeholder="No" class="border border-blue-200 rounded px-2 py-1 text-xs w-16 text-center focus:border-blue-500 outline-none">
                                        <button onclick="scrollToStudentNumber()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow">
                                            üéØ PERGI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="card-mobile">
                        <h4 class="text-sm font-bold text-sky-800 mb-3">KETERANGAN:</h4>
                        <div class="text-sm font-medium text-gray-700 leading-relaxed">
                            <span class="text-green-600 font-bold">S</span> = SETOR &nbsp;&nbsp;
                            <span class="text-red-600 font-bold">T</span> = TARIK &nbsp;&nbsp;
                            <span class="text-yellow-700 font-bold bg-yellow-200 px-1 rounded">S+T</span> = SETOR TARIK (kuning)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rekap Tab -->
            <div id="rekap" class="tab-content">
                <div class="space-y-4">
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-sky-800 flex items-center justify-center gap-2">
                            <span class="text-2xl">üìä</span>
                            REKAP BULANAN
                        </h2>
                    </div>

                    <!-- Filter Section -->
                    <div class="card-mobile">
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">BULAN</label>
                                <select id="rekapBulan" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none text-xs">
                                    <option value="all">SEMUA</option>
                                    <option value="1">JAN</option>
                                    <option value="2">FEB</option>
                                    <option value="3">MAR</option>
                                    <option value="4">APR</option>
                                    <option value="5">MEI</option>
                                    <option value="6">JUN</option>
                                    <option value="7">JUL</option>
                                    <option value="8">AGU</option>
                                    <option value="9">SEP</option>
                                    <option value="10">OKT</option>
                                    <option value="11">NOV</option>
                                    <option value="12">DES</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">TAHUN</label>
                                <select id="rekapTahun" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none text-xs">
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <button onclick="updateRekapTabel()" class="btn-mobile bg-pink-600 hover:bg-pink-700 text-white shadow-lg w-full text-xs px-1 py-1.5">
                                    üîç LIHAT
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Info Periode -->
                    <div id="infoPeriodeRekap" class="text-center text-pink-800 font-bold text-lg bg-pink-50 p-3 rounded-lg"></div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl p-3 shadow-lg text-center">
                            <div class="text-xs text-green-100 mb-1">TOTAL SETORAN</div>
                            <div id="totalSetoran" class="text-sm font-bold">Rp 0</div>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl p-3 shadow-lg text-center">
                            <div class="text-xs text-red-100 mb-1">TOTAL PENARIKAN</div>
                            <div id="totalPenarikan" class="text-sm font-bold">Rp 0</div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl p-3 shadow-lg text-center">
                            <div class="text-xs text-blue-100 mb-1">SALDO BERSIH</div>
                            <div id="saldoBersih" class="text-sm font-bold">Rp 0</div>
                        </div>
                    </div>

                    <!-- Tabel Rekap -->
                    <div class="card-mobile">
                        <h4 class="text-lg font-bold text-pink-800 mb-4">üìä REKAP PER SISWA</h4>
                        <div class="table-container">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white sticky top-0">
                                    <tr>
                                        <th class="text-xs font-medium text-left py-3">NO</th>
                                        <th class="text-xs font-medium text-left py-3">NAMA SISWA</th>
                                        <th class="text-xs font-medium text-center py-3">TOTAL SETOR</th>
                                        <th class="text-xs font-medium text-center py-3">TOTAL TARIK</th>
                                        <th class="text-xs font-medium text-right py-3">SALDO AKHIR</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelRekap">
                                    <tr>
                                        <td colspan="5" class="text-center text-gray-500 py-8 text-sm">
                                            PILIH PERIODE UNTUK MELIHAT REKAP
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unduh Tab -->
            <div id="unduh" class="tab-content">
                <div class="space-y-4">
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-sky-800 flex items-center justify-center gap-2">
                            <span class="text-2xl">üì•</span>
                            UNDUH LAPORAN
                        </h2>
                    </div>

                    <!-- Filter Section -->
                    <div class="card-mobile">
                        <h3 class="text-lg font-bold text-pink-800 mb-3">üìÖ PILIH PERIODE LAPORAN</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">BULAN</label>
                                <select id="unduhBulan" class="w-full p-3 border border-pink-200 rounded-lg focus:border-pink-500 outline-none text-sm">
                                    <option value="all">SEMUA TRANSAKSI</option>
                                    <option value="1">JANUARI</option>
                                    <option value="2">FEBRUARI</option>
                                    <option value="3">MARET</option>
                                    <option value="4">APRIL</option>
                                    <option value="5">MEI</option>
                                    <option value="6">JUNI</option>
                                    <option value="7">JULI</option>
                                    <option value="8">AGUSTUS</option>
                                    <option value="9">SEPTEMBER</option>
                                    <option value="10">OKTOBER</option>
                                    <option value="11">NOVEMBER</option>
                                    <option value="12">DESEMBER</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TAHUN</label>
                                <select id="unduhTahun" class="w-full p-3 border border-pink-200 rounded-lg focus:border-pink-500 outline-none text-sm">
                                    <option value="all">SEMUA TRANSAKSI</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="updateInfoPeriodeUnduh()" class="btn-mobile bg-pink-600 hover:bg-pink-700 text-white shadow-lg w-full mt-3">
                            üîÑ UPDATE PERIODE
                        </button>
                    </div>

                    <!-- Info Periode -->
                    <div id="infoPeriodeUnduh" class="text-center text-pink-800 font-bold text-lg bg-pink-50 p-3 rounded-lg"></div>

                    <!-- Download Options -->
                    <div class="grid grid-cols-1 gap-3">
                        <!-- Riwayat Transaksi -->
                        <div class="card-mobile bg-gradient-to-r from-blue-50 to-indigo-100 border-2 border-blue-200 py-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üìã</span>
                                    <div>
                                        <div class="text-sm font-bold text-blue-800">RIWAYAT TRANSAKSI</div>
                                        <div class="text-xs text-blue-600">Laporan harian</div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="unduhRiwayatPDF()" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold shadow">PDF</button>
                                    <button onclick="unduhRiwayatExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold shadow">XLS</button>
                                    <button onclick="unduhRiwayatCSV()" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold shadow">CSV</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rekap Tabungan -->
                        <div class="card-mobile bg-gradient-to-r from-purple-50 to-violet-100 border-2 border-purple-200 py-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üìà</span>
                                    <div>
                                        <div class="text-sm font-bold text-purple-800">REKAP TABUNGAN</div>
                                        <div class="text-xs text-purple-600">Laporan bulanan</div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="unduhRekapPDF()" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold shadow">PDF</button>
                                    <button onclick="unduhRekapExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold shadow">XLS</button>
                                    <button onclick="unduhRekapCSV()" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold shadow">CSV</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Share Reports -->
                        <div class="card-mobile bg-gradient-to-r from-orange-50 to-yellow-100 border-2 border-orange-200 py-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üì§</span>
                                    <div>
                                        <div class="text-sm font-bold text-orange-800">KIRIM LAPORAN</div>
                                        <div class="text-xs text-orange-600">Email & WhatsApp</div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="kirimViaEmail()" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold shadow flex items-center gap-1">
                                        <span>üìß</span>EMAIL
                                    </button>
                                    <button onclick="kirimViaWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold shadow flex items-center gap-1">
                                        <span>üì±</span>WA
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Backup & Restore -->
                        <div class="card-mobile bg-gradient-to-r from-teal-50 to-cyan-100 border-2 border-teal-200 py-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üíæ</span>
                                    <div>
                                        <div class="text-sm font-bold text-teal-800">BACKUP & RESTORE</div>
                                        <div class="text-xs text-teal-600">Cadangkan data</div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="backupData()" class="bg-teal-600 hover:bg-teal-700 text-white px-2 py-1 rounded text-xs font-bold shadow flex items-center gap-1">
                                        <span>üíæ</span>BACKUP
                                    </button>
                                    <button onclick="restoreData()" class="bg-amber-600 hover:bg-amber-700 text-white px-2 py-1 rounded text-xs font-bold shadow flex items-center gap-1">
                                        <span>üìÇ</span>RESTORE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Siswa -->
    <div id="modalTambah" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-sm mx-4 shadow-2xl border border-white border-opacity-20">
            <h3 class="text-lg font-bold text-pink-800 mb-4 flex items-center gap-2">
                <span class="text-xl">üë•</span>
                TAMBAH SISWA BARU
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NAMA SISWA *</label>
                    <input type="text" id="tambahNama" class="cool-input w-full border border-pink-200 rounded-lg p-3 focus:border-pink-500 outline-none text-sm" placeholder="MASUKKAN NAMA SISWA">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">KELAS</label>
                        <input type="text" id="tambahKelas" class="cool-input w-full border border-pink-200 rounded-lg p-3 focus:border-pink-500 outline-none text-sm" placeholder="CONTOH: 5A">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">JENIS KELAMIN</label>
                        <select id="tambahJenisKelamin" class="cool-input w-full border border-pink-200 rounded-lg p-3 focus:border-pink-500 outline-none text-sm">
                            <option value="Laki-laki">LAKI-LAKI</option>
                            <option value="Perempuan">PEREMPUAN</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="tutupModalTambah()" class="btn-mobile bg-gray-400 hover:bg-gray-500 text-white shadow-lg">
                    BATAL
                </button>
                <button onclick="simpanSiswaBaru()" class="btn-mobile bg-green-600 hover:bg-green-700 text-white shadow-lg">
                    TAMBAH SISWA
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Siswa -->
    <div id="modalEdit" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold text-sky-800 mb-4">‚úèÔ∏è EDIT DATA SISWA</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NAMA SISWA</label>
                    <input type="text" id="editNama" class="w-full p-3 border border-sky-200 rounded-lg focus:border-sky-500 outline-none text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">KELAS</label>
                        <input type="text" id="editKelas" class="w-full p-3 border border-sky-200 rounded-lg focus:border-sky-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">JENIS KELAMIN</label>
                        <select id="editJenisKelamin" class="w-full p-3 border border-sky-200 rounded-lg focus:border-sky-500 outline-none text-sm">
                            <option value="Laki-laki">LAKI-LAKI</option>
                            <option value="Perempuan">PEREMPUAN</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">SALDO</label>
                    <input type="number" id="editSaldo" class="w-full p-3 border border-sky-200 rounded-lg focus:border-sky-500 outline-none text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="tutupModal()" class="btn-mobile bg-gray-500 hover:bg-gray-600 text-white shadow-lg">
                    BATAL
                </button>
                <button onclick="simpanEdit()" class="btn-mobile bg-blue-600 hover:bg-blue-700 text-white shadow-lg">
                    SIMPAN
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Sekolah -->
    <div id="modalEditSekolah" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold text-sky-800 mb-4 flex items-center gap-2">
                <span class="text-xl">üè´</span>
                EDIT INFORMASI SEKOLAH
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NAMA SEKOLAH</label>
                    <input type="text" id="editNamaSekolah" class="w-full p-3 border border-sky-300 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none rounded-lg bg-white shadow-sm text-sm" placeholder="Masukkan nama sekolah">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">KELAS</label>
                        <input type="text" id="editKelasSekolah" class="w-full p-3 border border-sky-300 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none rounded-lg bg-white shadow-sm text-sm" placeholder="Contoh: 5A">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">WALI KELAS</label>
                        <input type="text" id="editWaliKelas" class="w-full p-3 border border-sky-300 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none rounded-lg bg-white shadow-sm text-sm" placeholder="Nama wali kelas">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="tutupModalEditSekolah()" class="btn-mobile bg-gray-400 hover:bg-gray-500 text-white shadow-lg">
                    BATAL
                </button>
                <button onclick="simpanInfoSekolah()" class="btn-mobile bg-sky-600 hover:bg-sky-700 text-white shadow-lg">
                    SIMPAN
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Excel Format Selection -->
    <div id="modalExcelFormat" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl border border-white border-opacity-20">
            <h3 class="text-lg font-bold text-sky-800 mb-4 flex items-center gap-2">
                <span class="text-xl">üìä</span>
                PILIH FORMAT EXCEL
            </h3>
            
            <div class="space-y-3">
                <button onclick="downloadExcelFormat('xlsx')" class="btn-mobile bg-green-600 hover:bg-green-700 text-white shadow-lg w-full flex items-center justify-center gap-2">
                    <span class="text-lg">üìä</span>
                    <span>XLSX (Excel 2007+)</span>
                </button>
                <button onclick="downloadExcelFormat('xls')" class="btn-mobile bg-blue-600 hover:bg-blue-700 text-white shadow-lg w-full flex items-center justify-center gap-2">
                    <span class="text-lg">üìã</span>
                    <span>XLS (Excel 97-2003)</span>
                </button>
                <button onclick="downloadExcelFormat('csv')" class="btn-mobile bg-orange-600 hover:bg-orange-700 text-white shadow-lg w-full flex items-center justify-center gap-2">
                    <span class="text-lg">üìÑ</span>
                    <span>CSV (Comma Separated)</span>
                </button>
            </div>
            
            <div class="mt-6">
                <button onclick="tutupModalExcelFormat()" class="btn-mobile bg-gray-400 hover:bg-gray-500 text-white shadow-lg w-full">
                    BATAL
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Detail Transaksi -->
    <div id="modalDetailTransaksi" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl border border-white border-opacity-20">
            <h3 class="text-lg font-bold text-sky-800 mb-4 flex items-center gap-2">
                <span class="text-xl">üìä</span>
                DETAIL TRANSAKSI
            </h3>
            
            <div class="space-y-4">
                <div class="bg-sky-50 p-4 rounded-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold text-sky-800" id="detailNamaSiswa">-</div>
                        <div class="text-sm text-sky-600" id="detailTanggal">-</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-green-50 p-3 rounded-lg text-center border border-green-200">
                        <div class="text-xs text-green-600 font-medium mb-1">SETOR HARI INI</div>
                        <div class="text-lg font-bold text-green-700" id="detailSetor">Rp 0</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg text-center border border-red-200">
                        <div class="text-xs text-red-600 font-medium mb-1">TARIK HARI INI</div>
                        <div class="text-lg font-bold text-red-700" id="detailTarik">Rp 0</div>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-200">
                    <div class="text-sm text-blue-600 font-medium mb-2">SALDO KESELURUHAN</div>
                    <div class="text-xl font-bold text-blue-700" id="detailSaldo">Rp 0</div>
                    <div class="text-xs text-blue-500 mt-1">Saldo dari awal sampai sekarang</div>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="tutupModalDetailTransaksi()" class="btn-mobile bg-sky-600 hover:bg-sky-700 text-white shadow-lg w-full">
                    TUTUP
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Form Transaksi -->
    <div id="modalFormTransaksi" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-sm mx-4 shadow-2xl border border-white border-opacity-20">
            <h3 class="text-lg font-bold text-sky-800 mb-4 flex items-center gap-2">
                <span class="text-xl">üí∞</span>
                FORM TRANSAKSI
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">TANGGAL TRANSAKSI</label>
                    <input type="date" id="tanggalTransaksi" class="w-full border border-sky-200 rounded-lg p-3 focus:border-sky-500 outline-none text-sm bg-white" onchange="updateTanggalDisplay()">
                    <div id="displayTanggal" class="text-xs text-sky-600 font-medium mt-1 text-center"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">PILIH SISWA</label>
                    <select id="pilihSiswa" class="cool-input w-full border border-sky-200 rounded-lg p-3 focus:border-sky-500 outline-none text-sm">
                        <option value="">-- PILIH SISWA --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">JUMLAH UANG (RP)</label>
                    <input type="text" id="jumlahTransaksi" class="cool-input w-full border border-sky-200 rounded-lg p-3 focus:border-sky-500 outline-none text-sm" placeholder="0" oninput="formatRupiah(this)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">JENIS TRANSAKSI</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btnSetor" onclick="pilihJenisTransaksi('setor')" class="btn-mobile bg-gray-200 hover:bg-green-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm">
                            üíµ SETOR
                        </button>
                        <button id="btnTarik" onclick="pilihJenisTransaksi('tarik')" class="btn-mobile bg-gray-200 hover:bg-red-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm">
                            üí∏ TARIK
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3 mt-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="tutupFormTransaksi()" class="btn-mobile bg-gray-400 hover:bg-gray-500 text-white shadow-lg">
                        BATAL
                    </button>
                    <button onclick="prosesTransaksi()" class="btn-mobile bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg">
                        ‚úÖ PROSES
                    </button>
                </div>
                <button onclick="tutupFormTransaksi()" class="btn-mobile bg-blue-600 hover:bg-blue-700 text-white shadow-lg w-full">
                    üèÅ SELESAI TRANSAKSI
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let siswaData = [];
        let transaksiData = [];
        let jenisTransaksiTerpilih = '';
        let siswaEditId = null;
        let soundEnabled = true; // Sound control variable

        // Download notification system
        function showDownloadNotification(message, type = 'info') {
            // Remove existing notification if any
            const existingNotif = document.getElementById('downloadNotification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            // Create notification backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'downloadNotification';
            backdrop.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm';
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'bg-white rounded-2xl p-8 shadow-2xl transform transition-all duration-300 ease-in-out scale-95 opacity-0 max-w-sm mx-4';
            
            // Set colors and content based on type
            let iconColor, icon, title;
            switch(type) {
                case 'loading':
                    iconColor = 'text-blue-500';
                    icon = '‚è≥';
                    title = 'MEMPROSES UNDUHAN';
                    playSound('upload');
                    break;
                case 'success':
                    iconColor = 'text-green-500';
                    icon = '‚úÖ';
                    title = 'UNDUHAN BERHASIL';
                    playSound('success');
                    break;
                case 'error':
                    iconColor = 'text-red-500';
                    icon = '‚ùå';
                    title = 'UNDUHAN GAGAL';
                    playSound('error');
                    break;
                default:
                    iconColor = 'text-gray-500';
                    icon = '‚ÑπÔ∏è';
                    title = 'INFORMASI';
            }
            
            notification.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl ${iconColor}">${icon}</span>
                        ${type === 'loading' ? '<div class="mt-2"><div class="animate-spin text-4xl text-blue-500">‚ö™</div></div>' : ''}
                    </div>
                    <div class="mb-4">
                        <div class="font-bold text-xl text-gray-800 mb-2">${title}</div>
                        <div class="text-gray-600 text-sm leading-relaxed">${message}</div>
                    </div>
                    ${type !== 'loading' ? `
                        <button onclick="closeDownloadNotification()" class="bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            TUTUP
                        </button>
                    ` : ''}
                </div>
            `;
            
            backdrop.appendChild(notification);
            document.body.appendChild(backdrop);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'scale(1)';
                notification.style.opacity = '1';
            }, 100);
            
            // Auto remove after delay (except for loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    closeDownloadNotification();
                }, type === 'success' ? 4000 : 6000);
            }
        }

        function closeDownloadNotification() {
            const notification = document.getElementById('downloadNotification');
            if (notification) {
                const popup = notification.querySelector('div');
                popup.style.transform = 'scale(0.8)';
                popup.style.opacity = '0';
                notification.style.opacity = '0';
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing app...');
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalTransaksi').value = today;
            
            // Load saved data
            loadFromLocalStorage();
            
            // Load sound preference
            loadSoundPreference();
            
            // Update displays
            updateAllDisplays();
            
            // Start real-time clock
            updateWaktu();
            setInterval(updateWaktu, 1000);
            
            // Add event listeners
            document.getElementById('tanggalTransaksi').addEventListener('change', function() {
                updateInfoTanggal();
                updateTanggalDisplay();
            });
            
            console.log('‚úÖ App initialized successfully!');
        });

        // Real-time clock update
        function updateWaktu() {
            const now = new Date();
            const hari = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const bulan = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
            
            const jam = now.getHours().toString().padStart(2, '0');
            const menit = now.getMinutes().toString().padStart(2, '0');
            
            // Update dashboard clock display with full format
            const waktuLengkap = `${hari[now.getDay()]} ${now.getDate()} ${bulan[now.getMonth()]} ${now.getFullYear()} | ${jam}:${menit}`;
            document.getElementById('waktuLengkap').textContent = waktuLengkap;
        }

        // Tab navigation
        function showTab(tabName) {
            // Play tab switch sound
            playSound('tab');
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Activate button
            event.target.closest('.tab-button').classList.add('active');
            
            // Show/hide header based on tab
            const header = document.querySelector('.gradient-header');
            const compactHeader = document.getElementById('compactHeader');
            
            if (tabName === 'dashboard') {
                header.style.display = 'block';
                compactHeader.classList.add('hidden');
            } else {
                header.style.display = 'none';
                compactHeader.classList.remove('hidden');
            }
            
            // Update displays for specific tabs
            if (tabName === 'riwayat') {
                setCurrentMonthYear('filter');
                updateRiwayatTabel();
            } else if (tabName === 'rekap') {
                setCurrentMonthYear('rekap');
                updateRekapTabel();
            } else if (tabName === 'unduh') {
                setCurrentMonthYear('unduh');
                updateInfoPeriodeUnduh();
                
                // Show notification popup when opening UNDUH tab
                setTimeout(() => {
                    alert('üìÖ PENTING - SELALU UPDATE PERIODE!\n\n‚ö†Ô∏è SELALU UPDATE PERIODE SAAT ANDA AKAN MENGUNDUH FILE AGAR DATA YANG DI UNDUH UPDATE\n\nüí° Tips:\n‚Ä¢ Klik tombol "üîÑ UPDATE PERIODE" sebelum mengunduh\n‚Ä¢ Pastikan bulan dan tahun sudah sesuai\n‚Ä¢ Data yang diunduh akan sesuai periode yang dipilih');
                }, 300);
            }
        }

        // Set current month and year for filters
        function setCurrentMonthYear(type) {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            if (type === 'filter') {
                document.getElementById('filterBulan').value = currentMonth;
                document.getElementById('filterTahun').value = currentYear;
            } else if (type === 'rekap') {
                document.getElementById('rekapBulan').value = currentMonth;
                document.getElementById('rekapTahun').value = currentYear;
            } else if (type === 'unduh') {
                document.getElementById('unduhBulan').value = currentMonth;
                document.getElementById('unduhTahun').value = currentYear;
            }
        }

        // Autosave functionality
        function showAutosaveNotification() {
            // Play save sound
            playSound('save');
            
            const notif = document.getElementById('autosaveNotif');
            const icon = document.getElementById('saveIcon');
            const text = document.getElementById('saveText');
            
            notif.style.opacity = '1';
            notif.style.transform = 'scale(1.05)';
            icon.textContent = '‚ö°';
            text.textContent = 'MENYIMPAN...';
            
            setTimeout(() => {
                // Play success sound when save completes
                playSound('notification');
                icon.textContent = '‚úÖ';
                text.textContent = 'TERSIMPAN OTOMATIS';
                notif.style.transform = 'scale(1)';
                
                setTimeout(() => {
                    icon.textContent = 'üíæ';
                }, 1000);
            }, 800);
        }

        function saveToLocalStorage() {
            try {
                const data = {
                    siswaData: siswaData,
                    transaksiData: transaksiData,
                    namaSekolah: document.getElementById('namaSekolah').value,
                    kelas: document.getElementById('kelas').value,
                    waliKelas: document.getElementById('waliKelas').value,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('tabunganSiswaData', JSON.stringify(data));
                showAutosaveNotification();
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('tabunganSiswaData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    siswaData = data.siswaData || [];
                    transaksiData = data.transaksiData || [];
                    
                    if (data.namaSekolah) document.getElementById('namaSekolah').value = data.namaSekolah;
                    if (data.kelas) document.getElementById('kelas').value = data.kelas;
                    if (data.waliKelas) document.getElementById('waliKelas').value = data.waliKelas;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        function triggerAutosave() {
            clearTimeout(window.autosaveTimeout);
            window.autosaveTimeout = setTimeout(saveToLocalStorage, 200);
        }

        // Student management
        function tambahSiswa() {
            playSound('modal');
            document.getElementById('tambahNama').value = '';
            document.getElementById('tambahKelas').value = document.getElementById('kelas').value || '';
            document.getElementById('tambahJenisKelamin').value = 'Laki-laki';
            document.getElementById('modalTambah').classList.remove('hidden');
            setTimeout(() => document.getElementById('tambahNama').focus(), 100);
        }

        function tutupModalTambah() {
            playSound('click');
            document.getElementById('modalTambah').classList.add('hidden');
        }

        function simpanSiswaBaru() {
            const nama = document.getElementById('tambahNama').value.trim();
            let kelas = document.getElementById('tambahKelas').value.trim();
            const jenisKelamin = document.getElementById('tambahJenisKelamin').value;

            if (!nama) {
                playSound('error');
                alert('Nama siswa wajib diisi!');
                return;
            }

            // Check for duplicate
            if (siswaData.find(s => s.nama.toLowerCase() === nama.toLowerCase())) {
                playSound('warning');
                alert('Siswa dengan nama tersebut sudah ada!');
                return;
            }

            // Auto-fill class from school info if not provided
            if (!kelas) {
                kelas = document.getElementById('kelas').value.trim();
            }

            const siswa = {
                id: Date.now(),
                nama: nama,
                kelas: kelas,
                jenisKelamin: jenisKelamin,
                saldo: 0
            };

            siswaData.push(siswa);
            updateAllDisplays();
            triggerAutosave();
            tutupModalTambah();
            
            playSound('success');
            let message = `‚úÖ Siswa ${nama} berhasil ditambahkan!`;
            if (kelas) {
                message += `\nüìö Kelas: ${kelas}`;
            }
            
            alert(message);
        }

        function editSiswa(id) {
            playSound('modal');
            const siswa = siswaData.find(s => s.id === id);
            if (siswa) {
                siswaEditId = id;
                document.getElementById('editNama').value = siswa.nama;
                document.getElementById('editKelas').value = siswa.kelas || '';
                document.getElementById('editJenisKelamin').value = siswa.jenisKelamin || 'Laki-laki';
                document.getElementById('editSaldo').value = siswa.saldo;
                document.getElementById('modalEdit').classList.remove('hidden');
            }
        }

        function tutupModal() {
            playSound('click');
            document.getElementById('modalEdit').classList.add('hidden');
            siswaEditId = null;
        }

        function simpanEdit() {
            const nama = document.getElementById('editNama').value.trim();
            const kelas = document.getElementById('editKelas').value.trim();
            const jenisKelamin = document.getElementById('editJenisKelamin').value;
            const saldo = parseInt(document.getElementById('editSaldo').value) || 0;

            if (!nama) {
                // Delete student if name is empty
                playSound('delete');
                siswaData = siswaData.filter(s => s.id !== siswaEditId);
                transaksiData = transaksiData.filter(t => t.siswaId !== siswaEditId);
            } else {
                // Update student
                playSound('success');
                const siswa = siswaData.find(s => s.id === siswaEditId);
                if (siswa) {
                    siswa.nama = nama;
                    siswa.kelas = kelas;
                    siswa.jenisKelamin = jenisKelamin;
                    siswa.saldo = saldo;
                }
            }

            tutupModal();
            updateAllDisplays();
            triggerAutosave();
        }

        // Excel upload
        function uploadData() {
            playSound('click');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = handleFileUpload;
            input.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                playSound('error');
                alert('Mohon pilih file Excel (.xlsx atau .xls)');
                return;
            }

            playSound('upload');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processExcelData(jsonData);
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    playSound('error');
                    alert('Gagal membaca file Excel. Pastikan format file benar.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            if (data.length < 2) {
                playSound('warning');
                alert('File Excel kosong atau tidak memiliki data yang cukup');
                return;
            }

            const headers = data[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            
            let namaIndex = headers.findIndex(h => 
                ['nama', 'name', 'student', 'siswa'].some(keyword => h.includes(keyword))
            );

            let jenisKelaminIndex = headers.findIndex(h => 
                ['jenis kelamin', 'kelamin', 'gender', 'sex', 'jk', 'l/p'].some(keyword => h.includes(keyword))
            );

            let kelasIndex = headers.findIndex(h => 
                ['kelas', 'class', 'grade'].some(keyword => h.includes(keyword))
            );

            if (namaIndex === -1) {
                playSound('error');
                alert('Kolom nama tidak ditemukan. Pastikan ada kolom dengan nama "Nama", "Name", atau "Siswa"');
                return;
            }

            let successCount = 0;
            let skipCount = 0;

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                const nama = row[namaIndex] ? row[namaIndex].toString().trim() : '';
                if (!nama) {
                    skipCount++;
                    continue;
                }

                if (siswaData.find(s => s.nama.toLowerCase() === nama.toLowerCase())) {
                    skipCount++;
                    continue;
                }

                let jenisKelamin = 'Laki-laki';
                if (jenisKelaminIndex !== -1 && row[jenisKelaminIndex]) {
                    const genderValue = row[jenisKelaminIndex].toString().toLowerCase().trim();
                    if (genderValue.includes('p') || genderValue.includes('perempuan') || 
                        genderValue.includes('female') || genderValue === 'f') {
                        jenisKelamin = 'Perempuan';
                    }
                }

                let kelas = '';
                if (kelasIndex !== -1 && row[kelasIndex]) {
                    kelas = row[kelasIndex].toString().trim();
                }
                
                // Auto-fill class from school info if not provided in Excel
                if (!kelas) {
                    kelas = document.getElementById('kelas').value.trim() || '';
                }

                const siswa = {
                    id: Date.now() + i,
                    nama: nama,
                    kelas: kelas,
                    jenisKelamin: jenisKelamin,
                    saldo: 0
                };

                siswaData.push(siswa);
                successCount++;
            }

            updateAllDisplays();
            triggerAutosave();

            playSound('success');
            let message = `Upload berhasil!\n\n`;
            message += `‚úÖ ${successCount} siswa berhasil ditambahkan\n`;
            if (skipCount > 0) {
                message += `‚ö†Ô∏è ${skipCount} baris dilewati (kosong atau duplikat)\n`;
            }
            message += `\nTotal siswa sekarang: ${siswaData.length}`;

            alert(message);
        }

        // Sound toggle function
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundIcon = document.getElementById('soundIcon');
            const soundButton = document.getElementById('soundToggle');
            
            if (soundEnabled) {
                soundIcon.textContent = 'üîä';
                soundButton.title = 'Matikan Suara (Sound ON)';
                soundButton.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                
                // Play confirmation sound when enabling
                setTimeout(() => playSound('notification'), 100);
                
                // Show notification
                setTimeout(() => {
                    alert('üîä SUARA DINYALAKAN\n\nEfek suara aplikasi sekarang aktif!');
                }, 200);
            } else {
                soundIcon.textContent = 'üîá';
                soundButton.title = 'Nyalakan Suara (Sound OFF)';
                soundButton.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                
                // Show notification (no sound when disabling)
                alert('üîá SUARA DIMATIKAN\n\nEfek suara aplikasi telah dinonaktifkan.');
            }
            
            // Save sound preference to localStorage
            localStorage.setItem('soundEnabled', soundEnabled.toString());
        }

        // Load sound preference from localStorage
        function loadSoundPreference() {
            const savedSoundPref = localStorage.getItem('soundEnabled');
            if (savedSoundPref !== null) {
                soundEnabled = savedSoundPref === 'true';
                const soundIcon = document.getElementById('soundIcon');
                const soundButton = document.getElementById('soundToggle');
                
                if (soundEnabled) {
                    soundIcon.textContent = 'üîä';
                    soundButton.title = 'Matikan Suara (Sound ON)';
                    soundButton.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                } else {
                    soundIcon.textContent = 'üîá';
                    soundButton.title = 'Nyalakan Suara (Sound OFF)';
                    soundButton.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                }
            }
        }

        // Enhanced Sound effects for all interactions
        function playSound(type) {
            // Check if sound is enabled
            if (!soundEnabled) {
                return; // Exit early if sound is disabled
            }
            
            try {
                // Create audio context for Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                let frequency, duration, volume, waveType = 'sine';
                
                switch(type) {
                    case 'setor':
                        // Happy ascending tone for setor (deposit)
                        frequency = 800; // Higher pitch for positive action
                        duration = 0.2;
                        volume = 0.3;
                        waveType = 'sine';
                        break;
                    case 'tarik':
                        // Lower tone for tarik (withdrawal)
                        frequency = 400; // Lower pitch
                        duration = 0.2;
                        volume = 0.3;
                        waveType = 'sine';
                        break;
                    case 'proses':
                        // Success sound for process
                        frequency = 600;
                        duration = 0.3;
                        volume = 0.4;
                        waveType = 'sine';
                        break;
                    case 'click':
                        // General button click sound
                        frequency = 1000;
                        duration = 0.1;
                        volume = 0.2;
                        waveType = 'square';
                        break;
                    case 'success':
                        // Success notification sound
                        frequency = 880;
                        duration = 0.4;
                        volume = 0.3;
                        waveType = 'sine';
                        break;
                    case 'error':
                        // Error notification sound
                        frequency = 200;
                        duration = 0.5;
                        volume = 0.4;
                        waveType = 'sawtooth';
                        break;
                    case 'warning':
                        // Warning notification sound
                        frequency = 500;
                        duration = 0.3;
                        volume = 0.3;
                        waveType = 'triangle';
                        break;
                    case 'tab':
                        // Tab switch sound
                        frequency = 1200;
                        duration = 0.08;
                        volume = 0.15;
                        waveType = 'sine';
                        break;
                    case 'modal':
                        // Modal open sound
                        frequency = 660;
                        duration = 0.15;
                        volume = 0.25;
                        waveType = 'sine';
                        break;
                    case 'save':
                        // Auto-save sound
                        frequency = 1320;
                        duration = 0.12;
                        volume = 0.2;
                        waveType = 'sine';
                        break;
                    case 'upload':
                        // Upload/download sound
                        frequency = 1100;
                        duration = 0.25;
                        volume = 0.3;
                        waveType = 'sine';
                        break;
                    case 'delete':
                        // Delete/remove sound
                        frequency = 300;
                        duration = 0.3;
                        volume = 0.35;
                        waveType = 'sawtooth';
                        break;
                    case 'notification':
                        // General notification sound
                        frequency = 750;
                        duration = 0.2;
                        volume = 0.25;
                        waveType = 'sine';
                        break;
                    default:
                        return;
                }
                
                // Create oscillator
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Configure sound
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = waveType;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                // Play sound
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
                
                // Special effects for certain sounds
                if (type === 'proses' || type === 'success') {
                    // Add harmonic for success sounds
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        
                        oscillator2.frequency.setValueAtTime(frequency * 1.5, audioContext.currentTime);
                        oscillator2.type = 'sine';
                        
                        gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode2.gain.linearRampToValueAtTime(volume * 0.5, audioContext.currentTime + 0.01);
                        gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration * 0.7);
                        
                        oscillator2.start(audioContext.currentTime);
                        oscillator2.stop(audioContext.currentTime + duration * 0.7);
                    }, 50);
                }
                
                if (type === 'error') {
                    // Add dissonant tone for error
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        
                        oscillator2.frequency.setValueAtTime(frequency * 0.8, audioContext.currentTime);
                        oscillator2.type = 'sawtooth';
                        
                        gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode2.gain.linearRampToValueAtTime(volume * 0.6, audioContext.currentTime + 0.01);
                        gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                        
                        oscillator2.start(audioContext.currentTime);
                        oscillator2.stop(audioContext.currentTime + duration);
                    }, 30);
                }
                
                if (type === 'upload') {
                    // Add ascending tones for upload
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        
                        oscillator2.frequency.setValueAtTime(frequency * 1.2, audioContext.currentTime);
                        oscillator2.type = 'sine';
                        
                        gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode2.gain.linearRampToValueAtTime(volume * 0.4, audioContext.currentTime + 0.01);
                        gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration * 0.8);
                        
                        oscillator2.start(audioContext.currentTime);
                        oscillator2.stop(audioContext.currentTime + duration * 0.8);
                    }, 80);
                }
                
            } catch (error) {
                // Fallback: console beep or silent fail
                console.log(`üîä Sound effect: ${type}`);
            }
        }

        // Transaction management
        function pilihJenisTransaksi(jenis) {
            jenisTransaksiTerpilih = jenis;
            
            // Play sound effect
            playSound(jenis);
            
            document.getElementById('btnSetor').className = 'btn-mobile bg-gray-200 hover:bg-green-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            document.getElementById('btnTarik').className = 'btn-mobile bg-gray-200 hover:bg-red-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            
            if (jenis === 'setor') {
                document.getElementById('btnSetor').className = 'btn-mobile bg-green-600 text-white border-2 border-green-400 shadow-lg text-sm';
            } else {
                document.getElementById('btnTarik').className = 'btn-mobile bg-red-600 text-white border-2 border-red-400 shadow-lg text-sm';
            }
        }

        function formatRupiah(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
            }
            input.value = value;
        }

        function getNumericValue(formattedValue) {
            return parseInt(formattedValue.replace(/\./g, '')) || 0;
        }

        // Transaction form popup functions
        function bukaFormTransaksi() {
            playSound('modal');
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalTransaksi').value = today;
            
            // Reset form
            document.getElementById('pilihSiswa').value = '';
            document.getElementById('jumlahTransaksi').value = '';
            jenisTransaksiTerpilih = '';
            document.getElementById('btnSetor').className = 'btn-mobile bg-gray-200 hover:bg-green-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            document.getElementById('btnTarik').className = 'btn-mobile bg-gray-200 hover:bg-red-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            
            // Update student list
            updatePilihSiswa();
            
            // Update date display
            updateTanggalDisplay();
            
            // Show modal
            document.getElementById('modalFormTransaksi').classList.remove('hidden');
            setTimeout(() => document.getElementById('pilihSiswa').focus(), 100);
        }

        function updateTanggalDisplay() {
            const tanggalInput = document.getElementById('tanggalTransaksi').value;
            const displayElement = document.getElementById('displayTanggal');
            
            if (tanggalInput) {
                const tanggal = new Date(tanggalInput);
                const hari = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
                
                const namaHari = hari[tanggal.getDay()];
                const tanggalFormatted = tanggal.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                
                displayElement.textContent = `${namaHari} ${tanggalFormatted}`;
                displayElement.className = 'text-xs text-sky-600 font-medium mt-1 text-center bg-sky-50 px-2 py-1 rounded';
            } else {
                displayElement.textContent = '';
                displayElement.className = 'text-xs text-sky-600 font-medium mt-1 text-center';
            }
        }

        function tutupFormTransaksi() {
            playSound('click');
            document.getElementById('modalFormTransaksi').classList.add('hidden');
        }

        function prosesTransaksi() {
            const siswaId = document.getElementById('pilihSiswa').value;
            const tanggal = document.getElementById('tanggalTransaksi').value;
            const jumlah = getNumericValue(document.getElementById('jumlahTransaksi').value);

            if (!siswaId || !tanggal || !jumlah || !jenisTransaksiTerpilih) {
                playSound('warning');
                alert('Mohon lengkapi semua data transaksi dan pilih jenis transaksi');
                return;
            }

            const siswa = siswaData.find(s => s.id == siswaId);
            if (!siswa) return;

            if (jenisTransaksiTerpilih === 'tarik' && siswa.saldo < jumlah) {
                playSound('error');
                alert('Saldo tidak mencukupi');
                return;
            }

            // Play success sound effect
            playSound('proses');

            // Update saldo
            if (jenisTransaksiTerpilih === 'setor') {
                siswa.saldo += jumlah;
            } else {
                siswa.saldo -= jumlah;
            }

            // Save transaction
            const transaksi = {
                id: Date.now(),
                siswaId: siswaId,
                nama: siswa.nama,
                jenis: jenisTransaksiTerpilih,
                jumlah: jumlah,
                tanggal: tanggal,
                tanggalInput: new Date().toLocaleString('id-ID')
            };
            transaksiData.push(transaksi);

            // Reset form fields but keep modal open
            document.getElementById('pilihSiswa').value = '';
            document.getElementById('jumlahTransaksi').value = '';
            jenisTransaksiTerpilih = '';
            document.getElementById('btnSetor').className = 'btn-mobile bg-gray-200 hover:bg-green-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            document.getElementById('btnTarik').className = 'btn-mobile bg-gray-200 hover:bg-red-500 hover:text-white text-gray-700 border-2 border-gray-300 text-sm';
            
            updateAllDisplays();
            triggerAutosave();
            
            alert(`‚úÖ TRANSAKSI ${jenisTransaksiTerpilih.toUpperCase()} BERHASIL!\n\nüí∞ ${siswa.nama}\nüíµ Rp ${jumlah.toLocaleString('id-ID')}\nüí≥ Saldo: Rp ${siswa.saldo.toLocaleString('id-ID')}\n\nüìù Form siap untuk transaksi berikutnya`);
            
            // Focus back to student selection for next transaction
            setTimeout(() => document.getElementById('pilihSiswa').focus(), 100);
        }

        function updateInfoTanggal() {
            const tanggalInput = document.getElementById('tanggalTransaksi').value;
            const infoTanggalEl = document.getElementById('infoTanggal');
            
            if (tanggalInput) {
                const tanggal = new Date(tanggalInput);
                const now = new Date();
                const hari = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
                const bulan = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                const jam = now.getHours().toString().padStart(2, '0');
                const menit = now.getMinutes().toString().padStart(2, '0');
                
                const infoString = `${hari[tanggal.getDay()]} ${tanggal.getDate()} ${bulan[tanggal.getMonth()]} ${tanggal.getFullYear()} | ${jam}:${menit}`;
                infoTanggalEl.textContent = infoString;
            } else {
                infoTanggalEl.textContent = '';
            }
            updateTabelTransaksi();
        }

        // School info management
        function showEditSekolahModal() {
            playSound('modal');
            document.getElementById('editNamaSekolah').value = document.getElementById('namaSekolah').value;
            document.getElementById('editKelasSekolah').value = document.getElementById('kelas').value;
            document.getElementById('editWaliKelas').value = document.getElementById('waliKelas').value;
            document.getElementById('modalEditSekolah').classList.remove('hidden');
            setTimeout(() => document.getElementById('editNamaSekolah').focus(), 100);
        }

        function tutupModalEditSekolah() {
            playSound('click');
            document.getElementById('modalEditSekolah').classList.add('hidden');
        }

        function simpanInfoSekolah() {
            const namaSekolah = document.getElementById('editNamaSekolah').value.trim();
            const kelas = document.getElementById('editKelasSekolah').value.trim();
            const waliKelas = document.getElementById('editWaliKelas').value.trim();
            
            document.getElementById('namaSekolah').value = namaSekolah;
            document.getElementById('kelas').value = kelas;
            document.getElementById('waliKelas').value = waliKelas;
            
            // Auto-fill class for all students who don't have a class or have empty class
            if (kelas) {
                siswaData.forEach(siswa => {
                    if (!siswa.kelas || siswa.kelas.trim() === '') {
                        siswa.kelas = kelas;
                    }
                });
                updateAllDisplays();
            }
            
            triggerAutosave();
            tutupModalEditSekolah();
            
            playSound('success');
            let message = '‚úÖ INFORMASI SEKOLAH BERHASIL DISIMPAN!';
            if (kelas) {
                const updatedCount = siswaData.filter(s => s.kelas === kelas).length;
                message += `\n\nüìö Kelas "${kelas}" telah diterapkan ke ${updatedCount} siswa yang belum memiliki kelas.`;
            }
            
            alert(message);
        }

        // Display updates
        function updateAllDisplays() {
            updateDashboardStats();
            updateDaftarSiswa();
            updatePilihSiswa();
            updateTabelTransaksi();
            
            // Always update rekap and riwayat to ensure data consistency
            updateRekapTabel();
            updateRiwayatTabel();
        }

        function updateDashboardStats() {
            // Total saldo
            const totalSaldo = siswaData.reduce((sum, siswa) => sum + siswa.saldo, 0);
            document.getElementById('totalSaldo').textContent = `Rp ${totalSaldo.toLocaleString('id-ID')}`;

            // Jumlah siswa
            const totalSiswa = siswaData.length;
            const siswaLaki = siswaData.filter(siswa => siswa.jenisKelamin === 'Laki-laki').length;
            const siswaPerempuan = siswaData.filter(siswa => siswa.jenisKelamin === 'Perempuan').length;
            
            document.getElementById('jumlahSiswa').innerHTML = `
                <div>${siswaLaki} L / ${totalSiswa} SISWA</div>
                <div>${siswaPerempuan} P / ${totalSiswa} SISWA</div>
            `;

            // Tabungan hari ini
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            
            const transaksiHariIni = transaksiData.filter(t => t.tanggal === todayString);
            
            const totalSetor = transaksiHariIni.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
            const totalTarik = transaksiHariIni.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
            
            document.getElementById('tabunganHariIni').innerHTML = `
                <div>SETOR: Rp ${totalSetor.toLocaleString('id-ID')}</div>
                <div>TARIK: Rp ${totalTarik.toLocaleString('id-ID')}</div>
            `;

            // Siswa aktif
            const siswaAktif = siswaData.filter(siswa => siswa.saldo > 0).length;
            document.getElementById('siswaAktif').textContent = `${siswaAktif}`;

            // Top 5 siswa
            const sorted = [...siswaData].sort((a, b) => b.saldo - a.saldo).slice(0, 5);
            const topSaldoHTML = sorted.length === 0 ? 
                '<div class="text-lg text-gray-500">Belum ada data</div>' :
                sorted.map((siswa, index) => `
                    <div class="flex justify-between items-center p-4 rounded-lg ${index === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 border border-yellow-300' : index === 1 ? 'bg-gradient-to-r from-gray-100 to-gray-200 border border-gray-300' : index === 2 ? 'bg-gradient-to-r from-orange-100 to-orange-200 border border-orange-300' : 'bg-gradient-to-r from-blue-100 to-blue-200 border border-blue-300'}">
                        <span class="text-sky-800 font-medium flex items-center gap-3">
                            <span class="text-2xl">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚≠ê'}</span>
                            ${siswa.nama}
                        </span>
                        <span class="font-bold text-sky-700 text-lg">Rp ${siswa.saldo.toLocaleString('id-ID')}</span>
                    </div>
                `).join('');
            
            document.getElementById('topSaldo').innerHTML = topSaldoHTML;
        }

        function updateDaftarSiswa() {
            const tabelBody = document.getElementById('tabelSiswa');
            const dataToShow = siswaData;
            
            if (dataToShow.length === 0) {
                tabelBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-12 text-sm">
                            <div class="flex flex-col items-center gap-3">
                                <span class="text-4xl">üë•</span>
                                <span class="font-medium">Belum ada siswa terdaftar</span>
                                <span class="text-xs text-gray-400">Klik tombol "TAMBAH SISWA" untuk menambah siswa baru</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tabelBody.innerHTML = dataToShow.map((siswa, index) => `
                <tr class="border-b border-gray-100 ${index % 2 === 0 ? 'bg-gradient-to-r from-indigo-50 to-purple-50' : 'bg-white'} hover:bg-gradient-to-r hover:from-yellow-50 hover:to-amber-50 transition-all duration-300">
                    <td class="text-gray-800 text-center font-bold text-sm py-4 px-3 border-r border-gray-100">
                        <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full flex items-center justify-center text-xs font-bold mx-auto">
                            ${index + 1}
                        </div>
                    </td>
                    <td class="text-gray-800 font-semibold text-sm py-4 px-4 border-r border-gray-100" title="${siswa.nama}">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${siswa.jenisKelamin === 'Perempuan' ? 'üë©‚Äçüéì' : 'üë®‚Äçüéì'}</span>
                            <span>${siswa.nama}</span>
                        </div>
                    </td>
                    <td class="text-gray-600 text-center text-sm py-4 px-3 border-r border-gray-100">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                            ${siswa.kelas || 'N/A'}
                        </span>
                    </td>
                    <td class="text-gray-600 text-center text-sm py-4 px-3 border-r border-gray-100">
                        <span class="text-2xl">${siswa.jenisKelamin === 'Perempuan' ? '‚ôÄÔ∏è' : '‚ôÇÔ∏è'}</span>
                    </td>
                    <td class="text-gray-800 font-bold text-right text-sm py-4 px-4 border-r border-gray-100 bg-gradient-to-r from-green-100 to-emerald-200">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-green-600">üí∞</span>
                            <span class="text-lg font-bold ${siswa.saldo > 0 ? 'text-green-700' : 'text-emerald-600'}">
                                Rp ${siswa.saldo.toLocaleString('id-ID')}
                            </span>
                        </div>
                    </td>
                    <td class="text-center py-4 px-3">
                        <button onclick="editSiswa(${siswa.id})" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-red-500 hover:to-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center gap-1 mx-auto">
                            <span>‚úèÔ∏è</span>
                            <span>EDIT</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePilihSiswa() {
            const select = document.getElementById('pilihSiswa');
            select.innerHTML = '<option value="">-- Pilih Siswa --</option>' +
                siswaData.map(siswa => `<option value="${siswa.id}">${siswa.nama}</option>`).join('');
        }

        function updateTabelTransaksi() {
            const tanggalTerpilih = document.getElementById('tanggalTransaksi').value;
            const tabelBody = document.getElementById('tabelTransaksi');
            
            if (!tanggalTerpilih) {
                tabelBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-gray-500 py-12 text-lg">
                            Pilih tanggal untuk melihat transaksi
                        </td>
                    </tr>
                `;
                return;
            }

            const transaksiHariIni = transaksiData.filter(t => t.tanggal === tanggalTerpilih);
            
            if (transaksiHariIni.length === 0) {
                tabelBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-gray-500 py-12 text-lg">
                            Belum ada transaksi pada tanggal ini
                        </td>
                    </tr>
                `;
                return;
            }

            // Group transactions by student
            const groupedTransaksi = {};
            transaksiHariIni.forEach(t => {
                if (!groupedTransaksi[t.siswaId]) {
                    const siswa = siswaData.find(s => s.id == t.siswaId);
                    groupedTransaksi[t.siswaId] = {
                        nama: t.nama,
                        setor: 0,
                        tarik: 0,
                        saldoAkhir: siswa ? siswa.saldo : 0
                    };
                }
                
                if (t.jenis === 'setor') {
                    groupedTransaksi[t.siswaId].setor += t.jumlah;
                } else {
                    groupedTransaksi[t.siswaId].tarik += t.jumlah;
                }
            });

            const rows = Object.values(groupedTransaksi).map(group => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm font-medium">${group.nama}</td>
                    <td class="py-3 px-2 text-center text-green-600 font-bold text-sm">
                        ${group.setor > 0 ? `Rp ${group.setor.toLocaleString('id-ID')}` : '-'}
                    </td>
                    <td class="py-3 px-2 text-center text-red-600 font-bold text-sm">
                        ${group.tarik > 0 ? `Rp ${group.tarik.toLocaleString('id-ID')}` : '-'}
                    </td>
                    <td class="py-3 px-2 text-right font-bold text-sm">
                        Rp ${group.saldoAkhir.toLocaleString('id-ID')}
                    </td>
                </tr>
            `).join('');

            tabelBody.innerHTML = rows;
        }

        // Transaction detail functions
        function showTransactionDetail(namaSiswa, tanggal, setor, tarik, saldo) {
            // Format tanggal
            const date = new Date(tanggal);
            const hari = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const bulan = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
            
            const tanggalFormatted = `${hari[date.getDay()]}, ${date.getDate()} ${bulan[date.getMonth()]} ${date.getFullYear()}`;
            
            // Update modal content
            document.getElementById('detailNamaSiswa').textContent = namaSiswa;
            document.getElementById('detailTanggal').textContent = tanggalFormatted;
            document.getElementById('detailSetor').textContent = `Rp ${setor.toLocaleString('id-ID')}`;
            document.getElementById('detailTarik').textContent = `Rp ${tarik.toLocaleString('id-ID')}`;
            document.getElementById('detailSaldo').textContent = `Rp ${saldo.toLocaleString('id-ID')}`;
            
            // Show modal
            document.getElementById('modalDetailTransaksi').classList.remove('hidden');
        }
        
        function tutupModalDetailTransaksi() {
            document.getElementById('modalDetailTransaksi').classList.add('hidden');
        }

        // Function to get display name for history table
        function getDisplayName(siswa, allSiswa) {
            const namaParts = siswa.nama.trim().split(' ');
            const namaDepan = namaParts[0];
            
            // Check if there are other students with the same first name
            const samaNamaDepan = allSiswa.filter(s => {
                const otherNamaParts = s.nama.trim().split(' ');
                return otherNamaParts[0].toLowerCase() === namaDepan.toLowerCase() && s.id !== siswa.id;
            });
            
            // If there are duplicates and student has a second name, use second name
            if (samaNamaDepan.length > 0 && namaParts.length > 1) {
                return namaParts[1];
            }
            
            // Otherwise use first name
            return namaDepan;
        }

        // Navigation variables
        let currentStudentPage = 0;
        const studentsPerPage = 10;

        // Riwayat functions
        function updateRiwayatTabel() {
            playSound('click');
            const bulan = parseInt(document.getElementById('filterBulan').value);
            const tahun = parseInt(document.getElementById('filterTahun').value);
            
            const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
            document.getElementById('infoBulanRiwayat').textContent = `RIWAYAT TRANSAKSI ${namaBulan[bulan]} ${tahun}`;
            
            // Get days in month
            const daysInMonth = new Date(tahun, bulan, 0).getDate();
            
            // Create header
            let headerHTML = '<th class="px-2 py-3 text-center font-medium border-r border-purple-400 sticky left-0 bg-purple-500 z-20">NO</th>';
            headerHTML += '<th class="px-3 py-3 text-left font-medium border-r border-purple-400 sticky left-12 bg-purple-500 z-20" style="left: 48px;">NAMA SISWA</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                headerHTML += `<th class="px-1 py-3 text-center font-medium border-r border-purple-400 text-xs" style="min-width: 30px;">${day}</th>`;
            }
            headerHTML += '<th class="px-2 py-3 text-center font-medium border-r border-purple-400 text-xs">SETOR</th>';
            headerHTML += '<th class="px-2 py-3 text-center font-medium border-r border-purple-400 text-xs">TARIK</th>';
            headerHTML += '<th class="px-2 py-3 text-center font-medium text-xs">SALDO</th>';
            
            document.getElementById('headerRiwayat').innerHTML = headerHTML;
            
            // Create body
            if (siswaData.length === 0) {
                document.getElementById('tabelRiwayat').innerHTML = `
                    <tr>
                        <td colspan="${daysInMonth + 5}" class="text-center text-gray-500 py-8 text-sm">
                            BELUM ADA DATA SISWA
                        </td>
                    </tr>
                `;
                hideNavigationControls();
                return;
            }
            
            let bodyHTML = '';
            siswaData.forEach((siswa, index) => {
                const displayName = getDisplayName(siswa, siswaData);
                
                let rowHTML = `<tr id="student-row-${index + 1}" class="border-b border-gray-100 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">`;
                rowHTML += `<td class="px-2 py-2 text-center text-xs font-bold sticky left-0 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} z-10 border-r border-gray-200">${index + 1}</td>`;
                rowHTML += `<td class="px-3 py-2 text-xs font-medium sticky ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} z-10 border-r border-gray-200" style="left: 48px;" title="${siswa.nama}">${displayName}</td>`;
                
                let totalSetor = 0;
                let totalTarik = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${tahun}-${String(bulan).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayTransactions = transaksiData.filter(t => {
                        return t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id);
                    });
                    
                    let cellContent = '-';
                    if (dayTransactions.length > 0) {
                        const hasSetor = dayTransactions.some(t => t.jenis === 'setor');
                        const hasTarik = dayTransactions.some(t => t.jenis === 'tarik');
                        
                        // Calculate totals for this month
                        totalSetor += dayTransactions.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                        totalTarik += dayTransactions.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                        
                        if (hasSetor && hasTarik) {
                            const totalSetorHari = dayTransactions.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                            const totalTarikHari = dayTransactions.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                            cellContent = `<span class="text-yellow-700 font-bold bg-yellow-200 px-1 rounded cursor-pointer hover:bg-yellow-300 transition-colors" onclick="showTransactionDetail('${siswa.nama}', '${dateString}', ${totalSetorHari}, ${totalTarikHari}, ${siswa.saldo})">S+T</span>`;
                        } else if (hasSetor) {
                            const totalSetorHari = dayTransactions.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                            cellContent = `<span class="text-green-600 font-bold bg-green-100 px-1 rounded cursor-pointer hover:bg-green-200 transition-colors" onclick="showTransactionDetail('${siswa.nama}', '${dateString}', ${totalSetorHari}, 0, ${siswa.saldo})">S</span>`;
                        } else if (hasTarik) {
                            const totalTarikHari = dayTransactions.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                            cellContent = `<span class="text-red-600 font-bold bg-red-100 px-1 rounded cursor-pointer hover:bg-red-200 transition-colors" onclick="showTransactionDetail('${siswa.nama}', '${dateString}', 0, ${totalTarikHari}, ${siswa.saldo})">T</span>`;
                        }
                    }
                    
                    rowHTML += `<td class="px-1 py-2 text-center text-xs border-r border-gray-200">${cellContent}</td>`;
                }
                
                // Add summary columns
                rowHTML += `<td class="px-2 py-2 text-center text-xs font-bold text-green-600 border-r border-gray-200">Rp ${totalSetor.toLocaleString('id-ID')}</td>`;
                rowHTML += `<td class="px-2 py-2 text-center text-xs font-bold text-red-600 border-r border-gray-200">Rp ${totalTarik.toLocaleString('id-ID')}</td>`;
                rowHTML += `<td class="px-2 py-2 text-center text-xs font-bold text-blue-600">Rp ${siswa.saldo.toLocaleString('id-ID')}</td>`;
                
                rowHTML += '</tr>';
                bodyHTML += rowHTML;
            });
            
            document.getElementById('tabelRiwayat').innerHTML = bodyHTML;
            
            // Show navigation controls and update them
            showNavigationControls();
            updateNavigationControls();
            updateJumpToStudentOptions();
            
            // Show scroll indicator if table is wide
            setTimeout(() => {
                const tableContainer = document.querySelector('.overflow-x-auto');
                if (tableContainer.scrollWidth > tableContainer.clientWidth) {
                    document.getElementById('scrollIndicator').classList.remove('hidden');
                } else {
                    document.getElementById('scrollIndicator').classList.add('hidden');
                }
            }, 100);
        }

        // Navigation functions
        function showNavigationControls() {
            if (siswaData.length > studentsPerPage) {
                document.getElementById('riwayatNavigation').classList.remove('hidden');
                document.getElementById('studentScrollControls').classList.remove('hidden');
            }
        }

        function hideNavigationControls() {
            document.getElementById('riwayatNavigation').classList.add('hidden');
            document.getElementById('studentScrollControls').classList.add('hidden');
        }

        function updateNavigationControls() {
            const totalPages = Math.ceil(siswaData.length / studentsPerPage);
            const startStudent = (currentStudentPage * studentsPerPage) + 1;
            const endStudent = Math.min((currentStudentPage + 1) * studentsPerPage, siswaData.length);
            
            // Update range display
            document.getElementById('currentStudentRange').textContent = `${startStudent}-${endStudent} dari ${siswaData.length}`;
            
            // Update button states
            document.getElementById('prevStudents').disabled = currentStudentPage === 0;
            document.getElementById('nextStudents').disabled = currentStudentPage >= totalPages - 1;
            
            // Update total count
            document.getElementById('totalStudentsCount').textContent = siswaData.length;
            document.getElementById('scrollToStudentNumber').max = siswaData.length;
        }

        function updateJumpToStudentOptions() {
            const select = document.getElementById('jumpToStudent');
            select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
            
            siswaData.forEach((siswa, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = `${index + 1}. ${siswa.nama}`;
                select.appendChild(option);
            });
        }

        function navigateStudents(direction) {
            playSound('click');
            
            if (direction === 'prev' && currentStudentPage > 0) {
                currentStudentPage--;
            } else if (direction === 'next') {
                const totalPages = Math.ceil(siswaData.length / studentsPerPage);
                if (currentStudentPage < totalPages - 1) {
                    currentStudentPage++;
                }
            }
            
            updateNavigationControls();
            
            // Scroll to the first student of the current page
            const targetStudentNumber = (currentStudentPage * studentsPerPage) + 1;
            scrollToStudentRow(targetStudentNumber);
        }

        function jumpToStudent() {
            const select = document.getElementById('jumpToStudent');
            const studentNumber = parseInt(select.value);
            
            if (studentNumber) {
                playSound('click');
                scrollToStudentRow(studentNumber);
                
                // Update current page based on selected student
                currentStudentPage = Math.floor((studentNumber - 1) / studentsPerPage);
                updateNavigationControls();
            }
        }

        function scrollToStudentNumber() {
            const input = document.getElementById('scrollToStudentNumber');
            const studentNumber = parseInt(input.value);
            
            if (studentNumber && studentNumber >= 1 && studentNumber <= siswaData.length) {
                playSound('click');
                scrollToStudentRow(studentNumber);
                
                // Update current page
                currentStudentPage = Math.floor((studentNumber - 1) / studentsPerPage);
                updateNavigationControls();
                
                // Clear input
                input.value = '';
                
                // Show success feedback
                const row = document.getElementById(`student-row-${studentNumber}`);
                if (row) {
                    row.style.backgroundColor = '#fef3c7'; // Yellow highlight
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);
                }
            } else {
                playSound('error');
                alert(`‚ùå Nomor siswa tidak valid!\n\nMasukkan nomor antara 1 sampai ${siswaData.length}`);
            }
        }

        function scrollToStudentRow(studentNumber) {
            const row = document.getElementById(`student-row-${studentNumber}`);
            if (row) {
                row.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Highlight the row temporarily
                row.style.backgroundColor = '#dbeafe'; // Blue highlight
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1500);
            }
        }

        function scrollToTop() {
            playSound('click');
            const tableContainer = document.querySelector('.overflow-x-auto');
            tableContainer.scrollTo({ 
                top: 0, 
                behavior: 'smooth' 
            });
            
            currentStudentPage = 0;
            updateNavigationControls();
        }

        function scrollToBottom() {
            playSound('click');
            const tableContainer = document.querySelector('.overflow-x-auto');
            tableContainer.scrollTo({ 
                top: tableContainer.scrollHeight, 
                behavior: 'smooth' 
            });
            
            const totalPages = Math.ceil(siswaData.length / studentsPerPage);
            currentStudentPage = totalPages - 1;
            updateNavigationControls();
        }

        // Rekap functions
        function updateRekapTabel() {
            playSound('click');
            const bulan = document.getElementById('rekapBulan').value;
            const tahun = parseInt(document.getElementById('rekapTahun').value);
            
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all') {
                const bulanInt = parseInt(bulan);
                filteredTransaksi = filteredTransaksi.filter(t => {
                    const tDate = new Date(t.tanggal);
                    return tDate.getMonth() + 1 === bulanInt && tDate.getFullYear() === tahun;
                });
                
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                document.getElementById('infoPeriodeRekap').textContent = `REKAP ${namaBulan[bulanInt]} ${tahun}`;
            } else {
                filteredTransaksi = filteredTransaksi.filter(t => {
                    const tDate = new Date(t.tanggal);
                    return tDate.getFullYear() === tahun;
                });
                document.getElementById('infoPeriodeRekap').textContent = `REKAP SEMUA BULAN ${tahun}`;
            }
            
            // Calculate totals
            const totalSetoran = filteredTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPenarikan = filteredTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
            const saldoBersih = totalSetoran - totalPenarikan;
            
            document.getElementById('totalSetoran').textContent = `Rp ${totalSetoran.toLocaleString('id-ID')}`;
            document.getElementById('totalPenarikan').textContent = `Rp ${totalPenarikan.toLocaleString('id-ID')}`;
            document.getElementById('saldoBersih').textContent = `Rp ${saldoBersih.toLocaleString('id-ID')}`;
            
            // Create table
            const tabelBody = document.getElementById('tabelRekap');
            
            if (siswaData.length === 0) {
                tabelBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-8 text-sm">
                            BELUM ADA DATA SISWA
                        </td>
                    </tr>
                `;
                return;
            }
            
            let bodyHTML = '';
            siswaData.forEach((siswa, index) => {
                // Filter transaksi untuk siswa ini berdasarkan siswaId (convert to number for comparison)
                const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                
                bodyHTML += `
                    <tr class="border-b border-gray-100 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50">
                        <td class="py-3 px-2 text-sm font-bold">${index + 1}</td>
                        <td class="py-3 px-2 text-sm font-medium">${siswa.nama}</td>
                        <td class="py-3 px-2 text-center text-green-600 font-bold text-sm">
                            Rp ${totalSetor.toLocaleString('id-ID')}
                        </td>
                        <td class="py-3 px-2 text-center text-red-600 font-bold text-sm">
                            Rp ${totalTarik.toLocaleString('id-ID')}
                        </td>
                        <td class="py-3 px-2 text-right font-bold text-sm">
                            Rp ${siswa.saldo.toLocaleString('id-ID')}
                        </td>
                    </tr>
                `;
            });
            
            tabelBody.innerHTML = bodyHTML;
        }

        // Excel format selection
        let currentExcelType = '';
        
        function showExcelFormatModal(type) {
            currentExcelType = type;
            document.getElementById('modalExcelFormat').classList.remove('hidden');
        }
        
        function tutupModalExcelFormat() {
            document.getElementById('modalExcelFormat').classList.add('hidden');
            currentExcelType = '';
        }
        
        function downloadExcelFormat(format) {
            console.log('üéØ downloadExcelFormat dipanggil dengan format:', format);
            console.log('üìã currentExcelType:', currentExcelType);
            
            // Validate XLSX library first
            if (typeof XLSX === 'undefined') {
                tutupModalExcelFormat();
                alert('‚ùå Library Excel tidak tersedia!\n\nüí° Solusi:\n1. Refresh halaman (Ctrl+F5)\n2. Pastikan koneksi internet stabil\n3. Coba lagi setelah beberapa saat');
                return;
            }
            
            // Validate data
            if (siswaData.length === 0) {
                tutupModalExcelFormat();
                alert('‚ùå Belum ada data siswa untuk diunduh!\n\nSilakan tambah siswa terlebih dahulu di tab SISWA.');
                return;
            }
            
            console.log('‚úÖ Validasi berhasil - Library:', typeof XLSX, 'Data siswa:', siswaData.length);
            
            // Close modal first
            tutupModalExcelFormat();
            
            // Add small delay to ensure modal closes smoothly
            setTimeout(() => {
                try {
                    if (currentExcelType === 'riwayat') {
                        console.log('üìä Memulai unduh riwayat...');
                        unduhRiwayatExcelImproved(format);
                    } else if (currentExcelType === 'rekap') {
                        console.log('üìà Memulai unduh rekap...');
                        unduhRekapExcelImproved(format);
                    } else {
                        console.error('‚ùå currentExcelType tidak valid:', currentExcelType);
                        alert('‚ùå Terjadi kesalahan sistem.\n\nüí° Solusi:\n1. Refresh halaman (Ctrl+F5)\n2. Pilih format Excel lagi\n3. Gunakan tombol TEST untuk cek browser support');
                    }
                } catch (error) {
                    console.error('‚ùå Error dalam downloadExcelFormat:', error);
                    alert(`‚ùå Terjadi kesalahan: ${error.message}\n\nüí° Solusi:\n1. Refresh halaman (Ctrl+F5)\n2. Gunakan browser Chrome/Firefox\n3. Coba format CSV sebagai alternatif\n4. Pastikan popup blocker tidak aktif`);
                }
                
                // Reset current type
                currentExcelType = '';
            }, 200);
        }

        // Improved Excel download functions
        function unduhRiwayatExcelImproved(format = 'xlsx') {
            console.log('üîÑ unduhRiwayatExcelImproved dimulai dengan format:', format);
            
            try {
                // Double check XLSX library
                if (typeof XLSX === 'undefined') {
                    throw new Error('Library XLSX tidak tersedia');
                }
                
                const bulan = document.getElementById('unduhBulan').value;
                const tahun = document.getElementById('unduhTahun').value;
                
                console.log('üìÖ Periode unduh:', { bulan, tahun });
                console.log('üë• Data siswa:', siswaData.length);
                console.log('üìä Data transaksi:', transaksiData.length);
                
                // Prepare data
                const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
                const kelas = document.getElementById('kelas').value || 'Kelas';
                const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
                
                let excelData = [];
                
                // Create header
                excelData.push(['RIWAYAT TRANSAKSI TABUNGAN SISWA']);
                excelData.push([]);
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                
                if (bulan === 'all') {
                    excelData.push(['Periode: SEMUA TRANSAKSI']);
                } else {
                    const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                    excelData.push([`Periode: ${namaBulan[parseInt(bulan)]} ${tahun}`]);
                }
                
                excelData.push([]);
                excelData.push(['NO', 'NAMA SISWA', 'TOTAL SETOR', 'TOTAL TARIK', 'SALDO AKHIR']);
                
                // Add student data
                siswaData.forEach((siswa, index) => {
                    let filteredTransaksi = transaksiData.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                    
                    if (bulan !== 'all') {
                        filteredTransaksi = filteredTransaksi.filter(t => {
                            const tDate = new Date(t.tanggal);
                            return (tDate.getMonth() + 1) === parseInt(bulan) && tDate.getFullYear() === parseInt(tahun);
                        });
                    }
                    
                    const totalSetor = filteredTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                    const totalTarik = filteredTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                    
                    excelData.push([
                        index + 1,
                        siswa.nama,
                        totalSetor,
                        totalTarik,
                        siswa.saldo
                    ]);
                });
                
                console.log('üìä Data Excel siap:', excelData.length, 'baris');
                
                // Create and download file
                downloadExcelFile(excelData, 'Riwayat_Transaksi', format);
                
            } catch (error) {
                console.error('‚ùå Error dalam unduhRiwayatExcelImproved:', error);
                throw error;
            }
        }
        
        function unduhRekapExcelImproved(format = 'xlsx') {
            console.log('üîÑ unduhRekapExcelImproved dimulai dengan format:', format);
            
            try {
                // Double check XLSX library
                if (typeof XLSX === 'undefined') {
                    throw new Error('Library XLSX tidak tersedia');
                }
                
                const bulan = document.getElementById('unduhBulan').value;
                const tahun = document.getElementById('unduhTahun').value;
                
                console.log('üìÖ Periode unduh:', { bulan, tahun });
                
                // Prepare data
                const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
                const kelas = document.getElementById('kelas').value || 'Kelas';
                const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
                
                let filteredTransaksi = transaksiData;
                
                if (bulan !== 'all' || tahun !== 'all') {
                    filteredTransaksi = transaksiData.filter(t => {
                        const tDate = new Date(t.tanggal);
                        const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                        const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                        return matchBulan && matchTahun;
                    });
                }
                
                let excelData = [];
                
                // Create header
                excelData.push(['REKAP TABUNGAN SISWA']);
                excelData.push([]);
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                
                if (bulan === 'all') {
                    excelData.push(['Periode: SEMUA TRANSAKSI']);
                } else {
                    const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                    excelData.push([`Periode: ${namaBulan[parseInt(bulan)]} ${tahun}`]);
                }
                
                excelData.push([]);
                excelData.push(['NO', 'NAMA SISWA', 'TOTAL SETOR', 'TOTAL TARIK', 'JUMLAH TRANSAKSI', 'SALDO AKHIR']);
                
                // Add student data
                siswaData.forEach((siswa, index) => {
                    const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                    const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                    const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                    const jumlahTransaksi = siswaTransaksi.length;
                    
                    excelData.push([
                        index + 1,
                        siswa.nama,
                        totalSetor,
                        totalTarik,
                        jumlahTransaksi,
                        siswa.saldo
                    ]);
                });
                
                console.log('üìä Data Excel siap:', excelData.length, 'baris');
                
                // Create and download file
                downloadExcelFile(excelData, 'Rekap_Tabungan', format);
                
            } catch (error) {
                console.error('‚ùå Error dalam unduhRekapExcelImproved:', error);
                throw error;
            }
        }
        
        function downloadExcelFile(data, baseName, format) {
            // Show loading notification
            showDownloadNotification(`Memproses unduhan ${format.toUpperCase()}...`, 'loading');
            
            console.log('üîÑ downloadExcelFile dimulai');
            console.log('üìä Data rows:', data.length);
            console.log('üìã Format:', format);
            
            try {
                // Create worksheet
                console.log('üîÑ Membuat worksheet...');
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Create workbook
                console.log('üîÑ Membuat workbook...');
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                
                // Validate format
                const validFormats = ['xlsx', 'xls', 'csv'];
                if (!validFormats.includes(format)) {
                    console.warn('‚ö†Ô∏è Format tidak valid, menggunakan xlsx');
                    format = 'xlsx';
                }
                
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `${baseName}_${timestamp}.${format}`;
                
                console.log('üìÅ Nama file:', fileName);
                
                // Try download with multiple fallback methods
                let success = false;
                let lastError = null;
                
                // Method 1: Direct writeFile (most compatible)
                try {
                    console.log('üîÑ Metode 1: XLSX.writeFile...');
                    XLSX.writeFile(wb, fileName, { 
                        bookType: format,
                        compression: true
                    });
                    success = true;
                    console.log('‚úÖ Unduh berhasil dengan writeFile');
                } catch (error1) {
                    console.warn('‚ö†Ô∏è writeFile gagal:', error1.message);
                    lastError = error1;
                    
                    // Method 2: Blob with createObjectURL
                    try {
                        console.log('üîÑ Metode 2: Blob download...');
                        
                        const wbout = XLSX.write(wb, { 
                            bookType: format, 
                            type: 'array'
                        });
                        
                        // Determine MIME type
                        let mimeType = 'application/octet-stream';
                        switch(format) {
                            case 'xlsx':
                                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                                break;
                            case 'xls':
                                mimeType = 'application/vnd.ms-excel';
                                break;
                            case 'csv':
                                mimeType = 'text/csv;charset=utf-8;';
                                break;
                        }
                        
                        const blob = new Blob([wbout], { type: mimeType });
                        
                        // Create and trigger download
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 1000);
                        
                        success = true;
                        console.log('‚úÖ Unduh berhasil dengan blob method');
                        
                    } catch (error2) {
                        console.warn('‚ö†Ô∏è Blob method gagal:', error2.message);
                        lastError = error2;
                        
                        // Method 3: Force download with data URI (last resort)
                        try {
                            console.log('üîÑ Metode 3: Data URI fallback...');
                            
                            if (format === 'csv') {
                                // Special handling for CSV
                                const csvContent = XLSX.utils.sheet_to_csv(ws);
                                const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
                                
                                const link = document.createElement('a');
                                link.setAttribute('href', encodedUri);
                                link.setAttribute('download', fileName);
                                link.style.display = 'none';
                                
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                success = true;
                                console.log('‚úÖ CSV berhasil dengan data URI');
                            } else {
                                throw new Error('Data URI method hanya untuk CSV');
                            }
                            
                        } catch (error3) {
                            console.error('‚ùå Semua metode gagal:', error3.message);
                            lastError = error3;
                        }
                    }
                }
                
                if (success) {
                    const successMsg = `‚úÖ FILE ${format.toUpperCase()} BERHASIL DIUNDUH!\n\n` +
                                     `üìÅ Nama file: ${fileName}\n` +
                                     `üìä ${data.length} baris data\n` +
                                     `üë• ${siswaData.length} siswa\n\n` +
                                     `üìÇ Silakan cek folder Downloads Anda.`;
                    
                    alert(successMsg);
                } else {
                    throw new Error(`Semua metode download gagal. Error terakhir: ${lastError ? lastError.message : 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error dalam downloadExcelFile:', error);
                
                const errorMsg = `‚ùå GAGAL MENGUNDUH FILE ${format.toUpperCase()}!\n\n` +
                               `Error: ${error.message}\n\n` +
                               `üí° SOLUSI YANG BISA DICOBA:\n` +
                               `1. Refresh halaman (Ctrl+F5)\n` +
                               `2. Gunakan browser Chrome atau Firefox\n` +
                               `3. Pastikan popup blocker tidak aktif\n` +
                               `4. Coba format CSV sebagai alternatif\n` +
                               `5. Gunakan tombol TEST untuk cek browser support\n` +
                               `6. Coba unduh dengan jumlah data lebih sedikit\n\n` +
                               `üìä Data tersedia: ${siswaData.length} siswa, ${transaksiData.length} transaksi`;
                
                alert(errorMsg);
                throw error;
            }
        }

        // Download functions
        function updateInfoPeriodeUnduh() {
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            let periodeText = '';
            if (bulan === 'all' && tahun === 'all') {
                periodeText = 'SEMUA TRANSAKSI';
            } else if (bulan === 'all') {
                periodeText = `SEMUA TRANSAKSI TAHUN ${tahun}`;
            } else if (tahun === 'all') {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                periodeText = `SEMUA TRANSAKSI BULAN ${namaBulan[parseInt(bulan)]}`;
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                periodeText = `PERIODE: ${namaBulan[parseInt(bulan)]} ${tahun}`;
            }
            
            document.getElementById('infoPeriodeUnduh').textContent = periodeText;
        }

        function unduhRiwayatExcel(format = 'xlsx') {
            console.log('üîÑ Memulai unduh riwayat Excel dengan format:', format);
            
            // Validate XLSX library
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Library Excel tidak tersedia!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            console.log('üìÖ Periode:', bulan, tahun);
            console.log('üë• Jumlah siswa:', siswaData.length);
            console.log('üìä Jumlah transaksi:', transaksiData.length);
            
            if (siswaData.length === 0) {
                alert('‚ùå Belum ada data siswa untuk diunduh!\n\nSilakan tambah siswa terlebih dahulu di tab SISWA.');
                return;
            }
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            let excelData = [];
            
            if (bulan === 'all') {
                // Get all unique months from transactions
                const uniqueMonths = [...new Set(transaksiData.map(t => {
                    const date = new Date(t.tanggal);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }))].sort();
                
                excelData.push(['RIWAYAT TRANSAKSI : SEMUA TRANSAKSI']);
                excelData.push([]);
                
                if (uniqueMonths.length === 0) {
                    excelData.push(['Belum ada transaksi']);
                } else {
                    uniqueMonths.forEach(monthYear => {
                        const [year, month] = monthYear.split('-');
                        const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                        
                        excelData.push([`TRANSAKSI : ${namaBulan[parseInt(month)]} ${year}`]);
                        excelData.push(['Sekolah:', namaSekolah]);
                        excelData.push(['Kelas:', kelas]);
                        excelData.push(['Wali Kelas:', waliKelas]);
                        excelData.push([]);
                        
                        // Get days in month
                        const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                        
                        // Create header
                        let headerRow = ['NO', 'NAMA SISWA'];
                        for (let day = 1; day <= daysInMonth; day++) {
                            headerRow.push(day.toString());
                        }
                        headerRow.push('SETOR', 'TARIK', 'SALDO');
                        excelData.push(headerRow);
                        
                        // Create data rows
                        siswaData.forEach((siswa, index) => {
                            let row = [index + 1, siswa.nama];
                            
                            let totalSetor = 0;
                            let totalTarik = 0;
                            
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dateString = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const dayTransactions = transaksiData.filter(t => t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id));
                                
                                let cellContent = '-';
                                if (dayTransactions.length > 0) {
                                    const hasSetor = dayTransactions.some(t => t.jenis === 'setor');
                                    const hasTarik = dayTransactions.some(t => t.jenis === 'tarik');
                                    
                                    if (hasSetor && hasTarik) {
                                        cellContent = 'S+T';
                                    } else if (hasSetor) {
                                        cellContent = 'S';
                                    } else if (hasTarik) {
                                        cellContent = 'T';
                                    }
                                    
                                    totalSetor += dayTransactions.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                                    totalTarik += dayTransactions.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                                }
                                
                                row.push(cellContent);
                            }
                            
                            row.push(totalSetor, totalTarik, siswa.saldo);
                            excelData.push(row);
                        });
                        
                        excelData.push([]);
                    });
                }
            } else {
                // Single month
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                excelData.push(['RIWAYAT TRANSAKSI']);
                excelData.push([`${namaBulan[parseInt(bulan)]} ${tahun}`]);
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                
                // Get days in month
                const daysInMonth = new Date(parseInt(tahun), parseInt(bulan), 0).getDate();
                
                // Create header
                let headerRow = ['NO', 'NAMA SISWA'];
                for (let day = 1; day <= daysInMonth; day++) {
                    headerRow.push(day.toString());
                }
                headerRow.push('SETOR', 'TARIK', 'SALDO');
                excelData.push(headerRow);
                
                // Create data rows
                siswaData.forEach((siswa, index) => {
                    let row = [index + 1, siswa.nama];
                    
                    let totalSetor = 0;
                    let totalTarik = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${tahun}-${String(bulan).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTransactions = transaksiData.filter(t => t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id));
                        
                        let cellContent = '-';
                        if (dayTransactions.length > 0) {
                            const hasSetor = dayTransactions.some(t => t.jenis === 'setor');
                            const hasTarik = dayTransactions.some(t => t.jenis === 'tarik');
                            
                            if (hasSetor && hasTarik) {
                                cellContent = 'S+T';
                            } else if (hasSetor) {
                                cellContent = 'S';
                            } else if (hasTarik) {
                                cellContent = 'T';
                            }
                            
                            totalSetor += dayTransactions.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                            totalTarik += dayTransactions.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                        }
                        
                        row.push(cellContent);
                    }
                    
                    row.push(totalSetor, totalTarik, siswa.saldo);
                    excelData.push(row);
                });
            }
            
            console.log('üìä Data Excel siap:', excelData.length, 'baris');
            
            // Create workbook and download with improved error handling
            try {
                console.log('üîÑ Membuat worksheet dari data...');
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                console.log('üîÑ Membuat workbook...');
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Riwayat Transaksi');
                
                console.log('‚úÖ Workbook berhasil dibuat');
                
                let fileName = '';
                let bookType = format;
                
                // Validate format
                if (!['xlsx', 'xls', 'csv'].includes(format)) {
                    console.warn('‚ö†Ô∏è Format tidak valid, menggunakan xlsx');
                    bookType = 'xlsx';
                }
                
                fileName = `Riwayat_Transaksi_${new Date().toISOString().split('T')[0]}.${bookType}`;
                
                console.log('üîÑ Mencoba mengunduh file:', fileName);
                console.log('üìã Format:', bookType);
                
                // Method 1: Try XLSX.writeFile first (most reliable)
                let downloadSuccess = false;
                let lastError = null;
                
                try {
                    console.log('üîÑ Metode 1: writeFile...');
                    XLSX.writeFile(wb, fileName, { 
                        bookType: bookType,
                        compression: true
                    });
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan writeFile');
                } catch (writeError) {
                    console.warn('‚ö†Ô∏è writeFile gagal:', writeError.message);
                    lastError = writeError;
                    
                    // Method 2: Manual blob download
                    try {
                        console.log('üîÑ Metode 2: blob download...');
                        const wbout = XLSX.write(wb, { 
                            bookType: bookType, 
                            type: 'array',
                            compression: true
                        });
                        
                        let mimeType = 'application/octet-stream';
                        if (bookType === 'xlsx') {
                            mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        } else if (bookType === 'xls') {
                            mimeType = 'application/vnd.ms-excel';
                        } else if (bookType === 'csv') {
                            mimeType = 'text/csv';
                        }
                        
                        const blob = new Blob([wbout], { type: mimeType });
                        
                        // Create download link
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        
                        // Trigger download
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup
                        setTimeout(() => {
                            if (document.body.contains(link)) {
                                document.body.removeChild(link);
                            }
                            URL.revokeObjectURL(url);
                        }, 1000);
                        
                        downloadSuccess = true;
                        console.log('‚úÖ File berhasil diunduh dengan blob method');
                    } catch (blobError) {
                        console.error('‚ùå Blob download gagal:', blobError.message);
                        lastError = blobError;
                        
                        // Method 3: Try with binary conversion
                        try {
                            console.log('üîÑ Metode 3: binary fallback...');
                            const wbout = XLSX.write(wb, { 
                                bookType: bookType, 
                                type: 'binary'
                            });
                            
                            // Convert binary string to array buffer
                            const buf = new ArrayBuffer(wbout.length);
                            const view = new Uint8Array(buf);
                            for (let i = 0; i < wbout.length; i++) {
                                view[i] = wbout.charCodeAt(i) & 0xFF;
                            }
                            
                            const blob = new Blob([buf], { type: 'application/octet-stream' });
                            
                            const link = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            
                            document.body.appendChild(link);
                            link.click();
                            
                            setTimeout(() => {
                                if (document.body.contains(link)) {
                                    document.body.removeChild(link);
                                }
                                URL.revokeObjectURL(url);
                            }, 1000);
                            
                            downloadSuccess = true;
                            console.log('‚úÖ File berhasil diunduh dengan binary fallback');
                        } catch (fallbackError) {
                            console.error('‚ùå Binary fallback gagal:', fallbackError.message);
                            lastError = fallbackError;
                        }
                    }
                }
                
                if (downloadSuccess) {
                    // Show success notification
                    setTimeout(() => {
                        showDownloadNotification(`${format.toUpperCase()} berhasil diunduh!`, 'success');
                    }, 500);
                    
                    alert(`‚úÖ File ${bookType.toUpperCase()} berhasil diunduh!\n\nüìÅ Nama file: ${fileName}\nüìä ${excelData.length} baris data\n\nSilakan cek folder Downloads Anda.`);
                } else {
                    throw new Error(`Semua metode download gagal. Error terakhir: ${lastError ? lastError.message : 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error dalam proses unduh:', error);
                
                // Show detailed error message
                let errorMsg = `‚ùå Gagal mengunduh file Excel!\n\n`;
                errorMsg += `Error: ${error.message}\n\n`;
                errorMsg += `üí° Solusi yang bisa dicoba:\n`;
                errorMsg += `1. Refresh halaman (Ctrl+F5)\n`;
                errorMsg += `2. Gunakan browser Chrome atau Firefox\n`;
                errorMsg += `3. Pastikan popup blocker tidak aktif\n`;
                errorMsg += `4. Coba format CSV sebagai alternatif\n`;
                errorMsg += `5. Gunakan tombol TEST untuk cek browser support\n\n`;
                errorMsg += `üìä Data tersedia: ${siswaData.length} siswa, ${transaksiData.length} transaksi`;
                
                alert(errorMsg);
            }
        }

        function unduhRekapExcel(format = 'xlsx') {
            console.log('üîÑ Memulai unduh rekap Excel dengan format:', format);
            
            // Validate XLSX library
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Library Excel tidak tersedia!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            console.log('üìÖ Periode:', bulan, tahun);
            console.log('üë• Jumlah siswa:', siswaData.length);
            console.log('üìä Jumlah transaksi:', transaksiData.length);
            
            if (siswaData.length === 0) {
                alert('‚ùå Belum ada data siswa untuk diunduh!\n\nSilakan tambah siswa terlebih dahulu di tab SISWA.');
                return;
            }
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            let filteredTransaksi = transaksiData;
            let excelData = [];
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            if (bulan === 'all') {
                excelData.push(['REKAP TRANSAKSI : SEMUA TRANSAKSI']);
                excelData.push([]);
                excelData.push(['SEMUA TRANSAKSI']);
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                excelData.push(['NO', 'NAMA SISWA', 'SETOR', 'TARIK', 'JUMLAH TRANSAKSI', 'SALDO AKHIR']);
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                excelData.push(['REKAP TRANSAKSI']);
                excelData.push([`${namaBulan[parseInt(bulan)]} ${tahun}`]);
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                excelData.push(['NO', 'NAMA SISWA', 'SETOR', 'TARIK', 'JUMLAH TRANSAKSI', 'SALDO AKHIR']);
            }
            
            siswaData.forEach((siswa, index) => {
                const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                const jumlahTransaksi = siswaTransaksi.length;
                
                excelData.push([
                    index + 1,
                    siswa.nama,
                    totalSetor,
                    totalTarik,
                    jumlahTransaksi,
                    siswa.saldo
                ]);
            });
            
            console.log('üìä Data Excel siap:', excelData.length, 'baris');
            
            // Create workbook and download with improved error handling
            try {
                console.log('üîÑ Membuat worksheet dari data...');
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                console.log('üîÑ Membuat workbook...');
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Transaksi');
                
                console.log('‚úÖ Workbook berhasil dibuat');
                
                let fileName = '';
                let bookType = format;
                
                // Validate format
                if (!['xlsx', 'xls', 'csv'].includes(format)) {
                    console.warn('‚ö†Ô∏è Format tidak valid, menggunakan xlsx');
                    bookType = 'xlsx';
                }
                
                fileName = `Rekap_Transaksi_${new Date().toISOString().split('T')[0]}.${bookType}`;
                
                console.log('üîÑ Mencoba mengunduh file:', fileName);
                console.log('üìã Format:', bookType);
                
                // Method 1: Try XLSX.writeFile first (most reliable)
                let downloadSuccess = false;
                let lastError = null;
                
                try {
                    console.log('üîÑ Metode 1: writeFile...');
                    XLSX.writeFile(wb, fileName, { 
                        bookType: bookType,
                        compression: true
                    });
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan writeFile');
                } catch (writeError) {
                    console.warn('‚ö†Ô∏è writeFile gagal:', writeError.message);
                    lastError = writeError;
                    
                    // Method 2: Manual blob download
                    try {
                        console.log('üîÑ Metode 2: blob download...');
                        const wbout = XLSX.write(wb, { 
                            bookType: bookType, 
                            type: 'array',
                            compression: true
                        });
                        
                        let mimeType = 'application/octet-stream';
                        if (bookType === 'xlsx') {
                            mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        } else if (bookType === 'xls') {
                            mimeType = 'application/vnd.ms-excel';
                        } else if (bookType === 'csv') {
                            mimeType = 'text/csv';
                        }
                        
                        const blob = new Blob([wbout], { type: mimeType });
                        
                        // Create download link
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        
                        // Trigger download
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup
                        setTimeout(() => {
                            if (document.body.contains(link)) {
                                document.body.removeChild(link);
                            }
                            URL.revokeObjectURL(url);
                        }, 1000);
                        
                        downloadSuccess = true;
                        console.log('‚úÖ File berhasil diunduh dengan blob method');
                    } catch (blobError) {
                        console.error('‚ùå Blob download gagal:', blobError.message);
                        lastError = blobError;
                        
                        // Method 3: Try with binary conversion
                        try {
                            console.log('üîÑ Metode 3: binary fallback...');
                            const wbout = XLSX.write(wb, { 
                                bookType: bookType, 
                                type: 'binary'
                            });
                            
                            // Convert binary string to array buffer
                            const buf = new ArrayBuffer(wbout.length);
                            const view = new Uint8Array(buf);
                            for (let i = 0; i < wbout.length; i++) {
                                view[i] = wbout.charCodeAt(i) & 0xFF;
                            }
                            
                            const blob = new Blob([buf], { type: 'application/octet-stream' });
                            
                            const link = document.createElement('a');
                            const url = URL.createObjectURL(blob);
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            
                            document.body.appendChild(link);
                            link.click();
                            
                            setTimeout(() => {
                                if (document.body.contains(link)) {
                                    document.body.removeChild(link);
                                }
                                URL.revokeObjectURL(url);
                            }, 1000);
                            
                            downloadSuccess = true;
                            console.log('‚úÖ File berhasil diunduh dengan binary fallback');
                        } catch (fallbackError) {
                            console.error('‚ùå Binary fallback gagal:', fallbackError.message);
                            lastError = fallbackError;
                        }
                    }
                }
                
                if (downloadSuccess) {
                    // Show success notification
                    setTimeout(() => {
                        showDownloadNotification(`${format.toUpperCase()} berhasil diunduh!`, 'success');
                    }, 500);
                    
                    alert(`‚úÖ File ${bookType.toUpperCase()} berhasil diunduh!\n\nüìÅ Nama file: ${fileName}\nüìä ${excelData.length} baris data\n\nSilakan cek folder Downloads Anda.`);
                } else {
                    throw new Error(`Semua metode download gagal. Error terakhir: ${lastError ? lastError.message : 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error dalam proses unduh:', error);
                
                // Show detailed error message
                let errorMsg = `‚ùå Gagal mengunduh file Excel!\n\n`;
                errorMsg += `Error: ${error.message}\n\n`;
                errorMsg += `üí° Solusi yang bisa dicoba:\n`;
                errorMsg += `1. Refresh halaman (Ctrl+F5)\n`;
                errorMsg += `2. Gunakan browser Chrome atau Firefox\n`;
                errorMsg += `3. Pastikan popup blocker tidak aktif\n`;
                errorMsg += `4. Coba format CSV sebagai alternatif\n`;
                errorMsg += `5. Gunakan tombol TEST untuk cek browser support\n\n`;
                errorMsg += `üìä Data tersedia: ${siswaData.length} siswa, ${transaksiData.length} transaksi`;
                
                alert(errorMsg);
            }
        }

        // Share functions
        function kirimViaEmail() {
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            // Generate report summary
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            const namaSekolah = document.getElementById('namaSekolah').value || '[ISI NAMA SEKOLAH]';
            const kelas = document.getElementById('kelas').value || '[ISI KELAS]';
            const waliKelas = document.getElementById('waliKelas').value || '[ISI NAMA WALI KELAS]';
            
            // Determine period text
            let periodeText = '';
            if (bulan === 'all') {
                periodeText = 'SEMUA TRANSAKSI';
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                periodeText = `${namaBulan[parseInt(bulan)]} ${tahun}`;
            }
            
            // Create email content with new format
            const subject = `Laporan Rekap Tabungan - ${namaSekolah} ${kelas}`;
            let body = `NAMA SEKOLAH : ${namaSekolah}
KELAS : ${kelas}
NAMA WALI KELAS : ${waliKelas}

=== REKAP TABUNGAN : ${periodeText} ===

`;
            
            // Add student details
            siswaData.forEach((siswa, index) => {
                const siswaTransaksi = filteredTransaksi.filter(t => t.siswaId === siswa.id);
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                
                body += `${index + 1}. ${siswa.nama.toUpperCase()} :
SETOR : Rp ${totalSetor.toLocaleString('id-ID')}
TARIK : Rp ${totalTarik.toLocaleString('id-ID')}
SALDO AKHIR : Rp ${siswa.saldo.toLocaleString('id-ID')}

`;
            });
            
            body += `laporan rekap ini di buat oleh aplikasi tabungan digital`;
            
            // Open email client
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
            
            alert('üìß Aplikasi email akan terbuka untuk mengirim laporan!');
        }

        function kirimViaWhatsApp() {
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            // Generate report summary
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            const namaSekolah = document.getElementById('namaSekolah').value || '[ISI NAMA SEKOLAH]';
            const kelas = document.getElementById('kelas').value || '[ISI KELAS]';
            const waliKelas = document.getElementById('waliKelas').value || '[ISI NAMA WALI KELAS]';
            
            // Determine period text
            let periodeText = '';
            if (bulan === 'all') {
                periodeText = 'SEMUA TRANSAKSI';
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                periodeText = `${namaBulan[parseInt(bulan)]} ${tahun}`;
            }
            
            // Create WhatsApp message with new format
            let message = `*NAMA SEKOLAH :* ${namaSekolah}
*KELAS :* ${kelas}
*NAMA WALI KELAS :* ${waliKelas}

*=== REKAP TABUNGAN : ${periodeText} ===*

`;
            
            // Add student details
            siswaData.forEach((siswa, index) => {
                const siswaTransaksi = filteredTransaksi.filter(t => t.siswaId === siswa.id);
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                
                message += `*${index + 1}. ${siswa.nama.toUpperCase()} :*
SETOR : Rp ${totalSetor.toLocaleString('id-ID')}
TARIK : Rp ${totalTarik.toLocaleString('id-ID')}
SALDO AKHIR : Rp ${siswa.saldo.toLocaleString('id-ID')}

`;
            });
            
            message += `_laporan rekap ini di buat oleh aplikasi tabungan digital_`;
            
            // Open WhatsApp
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappLink, '_blank');
            
            alert('üì± WhatsApp akan terbuka untuk mengirim laporan!');
        }

        // PDF Download Functions with improved formatting
        function unduhRiwayatPDF() {
            // Show loading notification
            showDownloadNotification('Memproses unduhan PDF Riwayat...', 'loading');
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a2'); // A2 landscape for maximum space
            
            // Page dimensions for landscape A2
            const pageWidth = 594;
            const pageHeight = 420;
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2);
            
            let yPosition = margin;
            
            // Helper function to format amount in thousands
            function formatAmount(amount) {
                if (amount === 0) return '-';
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(1) + 'jt';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(0) + 'rb';
                } else {
                    return amount.toString();
                }
            }
            
            // Helper function to draw daily transaction table
            function drawDailyTable(monthYear = null, isAllTransactions = false) {
                let currentMonth, currentYear;
                
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    currentMonth = parseInt(month);
                    currentYear = parseInt(year);
                } else {
                    currentMonth = parseInt(bulan);
                    currentYear = parseInt(tahun);
                }
                
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                // Check if we need a new page for the table
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                const estimatedTableHeight = (siswaData.length * 12) + 60; // More space for amounts
                
                if (yPosition + estimatedTableHeight > pageHeight - 30) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                // Title for this month section
                if (isAllTransactions) {
                    doc.setFillColor(52, 73, 94); // Dark blue
                    doc.rect(margin, yPosition, contentWidth, 18, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TRANSAKSI : ${namaBulan[currentMonth]} ${currentYear}`, margin + 10, yPosition + 12);
                    yPosition += 25;
                } else {
                    doc.setFillColor(52, 73, 94); // Dark blue
                    doc.rect(margin, yPosition, contentWidth, 18, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`RIWAYAT TRANSAKSI`, margin + 10, yPosition + 12);
                    yPosition += 25;
                    
                    // Month and year
                    doc.setFillColor(41, 128, 185); // Blue
                    doc.rect(margin, yPosition, contentWidth, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.text(`${namaBulan[currentMonth]} ${currentYear}`, margin + 10, yPosition + 10);
                    yPosition += 20;
                }
                
                // School info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Sekolah: ${namaSekolah}`, margin, yPosition + 8);
                doc.text(`Kelas: ${kelas}`, margin, yPosition + 18);
                doc.text(`Wali Kelas: ${waliKelas}`, margin, yPosition + 28);
                yPosition += 35;
                
                // Calculate column widths dynamically for A2
                const noColWidth = 20;
                const namaColWidth = 80;
                const availableForDays = contentWidth - noColWidth - namaColWidth;
                const dayColWidth = Math.max(15, availableForDays / daysInMonth); // Minimum 15mm per day for A2
                
                // Table header
                const rowHeight = 12;
                let xPos = margin;
                
                // Header background
                doc.setFillColor(149, 165, 166); // Light gray
                doc.rect(margin, yPosition, contentWidth, rowHeight + 3, 'F');
                
                // Header text
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                
                // NO column
                doc.text('NO', xPos + (noColWidth/2), yPosition + 9, { align: 'center' });
                xPos += noColWidth;
                
                // NAMA SISWA column
                doc.text('NAMA SISWA', xPos + (namaColWidth/2), yPosition + 9, { align: 'center' });
                xPos += namaColWidth;
                
                // Day columns (1, 2, 3, ... end of month)
                for (let day = 1; day <= daysInMonth; day++) {
                    doc.text(day.toString(), xPos + (dayColWidth/2), yPosition + 9, { align: 'center' });
                    xPos += dayColWidth;
                }
                
                yPosition += rowHeight + 5;
                
                // Table data rows
                doc.setFont('helvetica', 'normal');
                siswaData.forEach((siswa, index) => {
                    // Check if we need a new page
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = margin + 20;
                    }
                    
                    // Row background (alternating colors)
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 249, 250); // Very light gray
                        doc.rect(margin, yPosition - 2, contentWidth, rowHeight, 'F');
                    }
                    
                    xPos = margin;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    
                    // NO
                    doc.text((index + 1).toString(), xPos + (noColWidth/2), yPosition + 8, { align: 'center' });
                    xPos += noColWidth;
                    
                    // NAMA (truncate if too long)
                    const namaDisplay = siswa.nama.length > 30 ? siswa.nama.substring(0, 27) + '...' : siswa.nama;
                    doc.text(namaDisplay, xPos + 5, yPosition + 8);
                    xPos += namaColWidth;
                    
                    // Daily transaction columns
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTransactions = transaksiData.filter(t => {
                            return t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id);
                        });
                        
                        let cellContent = '-';
                        let cellColor = [100, 100, 100]; // Default gray
                        let bgColor = null;
                        
                        if (dayTransactions.length > 0) {
                            const setorTransactions = dayTransactions.filter(t => t.jenis === 'setor');
                            const tarikTransactions = dayTransactions.filter(t => t.jenis === 'tarik');
                            
                            const totalSetor = setorTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            const totalTarik = tarikTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            
                            if (totalSetor > 0 && totalTarik > 0) {
                                // Both setor and tarik - show detailed format +100k/-10k
                                cellContent = `+${formatAmount(totalSetor)}/-${formatAmount(totalTarik)}`;
                                cellColor = [184, 134, 11]; // Yellow/Orange for mixed
                                bgColor = [255, 235, 59]; // Light yellow background
                            } else if (totalSetor > 0) {
                                // Only setor
                                cellContent = '+' + formatAmount(totalSetor);
                                cellColor = [34, 139, 34]; // Green
                                bgColor = [144, 238, 144]; // Light green
                            } else if (totalTarik > 0) {
                                // Only tarik
                                cellContent = '-' + formatAmount(totalTarik);
                                cellColor = [220, 20, 60]; // Red
                                bgColor = [255, 182, 193]; // Light red
                            }
                        }
                        
                        // Draw background color if exists
                        if (bgColor) {
                            doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                            doc.rect(xPos, yPosition - 2, dayColWidth, rowHeight, 'F');
                        }
                        
                        doc.setTextColor(cellColor[0], cellColor[1], cellColor[2]);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(8);
                        doc.text(cellContent, xPos + (dayColWidth/2), yPosition + 8, { align: 'center' });
                        xPos += dayColWidth;
                    }
                    
                    yPosition += rowHeight;
                });
                
                yPosition += 20; // Space after table
            }
            
            // Main logic
            if (bulan === 'all') {
                // Get all unique months from transactions
                const uniqueMonths = [...new Set(transaksiData.map(t => {
                    const date = new Date(t.tanggal);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }))].sort();
                
                if (uniqueMonths.length === 0) {
                    // Main title for all transactions
                    doc.setFillColor(52, 73, 94); // Dark blue
                    doc.rect(margin, yPosition, contentWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RIWAYAT TRANSAKSI : SEMUA TRANSAKSI', pageWidth/2, yPosition + 16, { align: 'center' });
                    yPosition += 35;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(16);
                    doc.text('Belum ada transaksi yang tercatat', pageWidth/2, yPosition + 30, { align: 'center' });
                } else {
                    // Main title for all transactions
                    doc.setFillColor(52, 73, 94); // Dark blue
                    doc.rect(margin, yPosition, contentWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RIWAYAT TRANSAKSI : SEMUA TRANSAKSI', pageWidth/2, yPosition + 16, { align: 'center' });
                    yPosition += 35;
                    
                    uniqueMonths.forEach((monthYear, index) => {
                        if (index > 0) {
                            yPosition += 15; // Extra space between months
                        }
                        drawDailyTable(monthYear, true);
                    });
                }
            } else {
                drawDailyTable();
            }
            
            // Add footer with legend on last page
            const footerY = pageHeight - 20;
            doc.setFillColor(236, 240, 241); // Light background
            doc.rect(margin, footerY - 15, contentWidth, 20, 'F');
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('KETERANGAN:', margin + 10, footerY - 8);
            
            // Legend with colors and examples
            let legendX = margin + 80;
            doc.setTextColor(34, 139, 34); // Green
            doc.text('‚ñ† SETOR = + (HIJAU)', legendX, footerY - 8);
            legendX += 90;
            
            doc.setTextColor(220, 20, 60); // Red
            doc.text('‚ñ† TARIK = - (MERAH)', legendX, footerY - 8);
            legendX += 90;
            
            doc.setTextColor(184, 134, 11); // Yellow/Orange for mixed transactions
            doc.text('‚ñ† SETOR + TARIK = +/- (KUNING)', legendX, footerY - 8);
            
            // Format explanation
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Format: rb = ribu, jt = juta | Warna hijau = setor, merah = tarik', margin + 10, footerY - 2);
            
            // Date generated
            doc.setTextColor(127, 140, 141);
            doc.text(`Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`, pageWidth - margin - 10, footerY - 2, { align: 'right' });
            
            const fileName = `Riwayat_Transaksi_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            // Show success notification
            setTimeout(() => {
                showDownloadNotification('PDF Riwayat berhasil diunduh!', 'success');
            }, 500);
            
            alert('‚úÖ File PDF Riwayat berhasil diunduh!\n\nüìÑ Format: A2 Landscape\nüí∞ Format: +100k/-10k untuk setor dan tarik di hari yang sama\nüé® Dengan warna latar belakang sesuai jenis transaksi\nüìÅ Silakan cek folder Downloads Anda');
        }

        function unduhRekapPDF() {
            // Show loading notification
            showDownloadNotification('Memproses unduhan PDF Rekap...', 'loading');
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a3'); // A3 landscape for more space
            
            // Page dimensions for landscape A3
            const pageWidth = 420;
            const pageHeight = 297;
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2);
            
            let yPosition = margin;
            
            // Header with background
            doc.setFillColor(52, 73, 94); // Dark blue
            doc.rect(margin, yPosition, contentWidth, 30, 'F');
            
            // Title
            doc.setTextColor(255, 255, 255); // White text
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            
            if (bulan === 'all') {
                doc.text('REKAP TABUNGAN SISWA - SEMUA PERIODE', pageWidth/2, yPosition + 12, { align: 'center' });
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                doc.text(`REKAP TABUNGAN SISWA - ${namaBulan[parseInt(bulan)]} ${tahun}`, pageWidth/2, yPosition + 12, { align: 'center' });
            }
            
            // School info
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`${namaSekolah} | Kelas: ${kelas} | Wali Kelas: ${waliKelas}`, pageWidth/2, yPosition + 22, { align: 'center' });
            
            yPosition += 40;
            
            // Summary statistics
            const totalSetoran = filteredTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPenarikan = filteredTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
            const saldoBersih = totalSetoran - totalPenarikan;
            const totalSiswa = siswaData.length;
            const siswaAktif = siswaData.filter(s => s.saldo > 0).length;
            
            // Summary boxes
            const boxWidth = (contentWidth - 20) / 4;
            const boxHeight = 25;
            let boxX = margin;
            
            // Total Setoran
            doc.setFillColor(46, 204, 113); // Green
            doc.rect(boxX, yPosition, boxWidth, boxHeight, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL SETORAN', boxX + boxWidth/2, yPosition + 8, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Rp ${totalSetoran.toLocaleString('id-ID')}`, boxX + boxWidth/2, yPosition + 18, { align: 'center' });
            
            boxX += boxWidth + 5;
            
            // Total Penarikan
            doc.setFillColor(231, 76, 60); // Red
            doc.rect(boxX, yPosition, boxWidth, boxHeight, 'F');
            doc.text('TOTAL PENARIKAN', boxX + boxWidth/2, yPosition + 8, { align: 'center' });
            doc.text(`Rp ${totalPenarikan.toLocaleString('id-ID')}`, boxX + boxWidth/2, yPosition + 18, { align: 'center' });
            
            boxX += boxWidth + 5;
            
            // Saldo Bersih
            doc.setFillColor(52, 152, 219); // Blue
            doc.rect(boxX, yPosition, boxWidth, boxHeight, 'F');
            doc.text('SALDO BERSIH', boxX + boxWidth/2, yPosition + 8, { align: 'center' });
            doc.text(`Rp ${saldoBersih.toLocaleString('id-ID')}`, boxX + boxWidth/2, yPosition + 18, { align: 'center' });
            
            boxX += boxWidth + 5;
            
            // Siswa Aktif
            doc.setFillColor(155, 89, 182); // Purple
            doc.rect(boxX, yPosition, boxWidth, boxHeight, 'F');
            doc.text('SISWA AKTIF', boxX + boxWidth/2, yPosition + 8, { align: 'center' });
            doc.text(`${siswaAktif} / ${totalSiswa}`, boxX + boxWidth/2, yPosition + 18, { align: 'center' });
            
            yPosition += 40;
            
            // Table header
            const rowHeight = 12;
            const colWidths = [25, 100, 60, 60, 50, 70]; // NO, NAMA, SETOR, TARIK, TRANSAKSI, SALDO (adjusted for A3)
            let xPos = margin;
            
            // Header background
            doc.setFillColor(149, 165, 166); // Light gray
            doc.rect(margin, yPosition, contentWidth, rowHeight + 2, 'F');
            
            // Header text
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            
            doc.text('NO', xPos + (colWidths[0]/2), yPosition + 8, { align: 'center' });
            xPos += colWidths[0];
            doc.text('NAMA SISWA', xPos + (colWidths[1]/2), yPosition + 8, { align: 'center' });
            xPos += colWidths[1];
            doc.text('TOTAL SETOR', xPos + (colWidths[2]/2), yPosition + 8, { align: 'center' });
            xPos += colWidths[2];
            doc.text('TOTAL TARIK', xPos + (colWidths[3]/2), yPosition + 8, { align: 'center' });
            xPos += colWidths[3];
            doc.text('JML TRANSAKSI', xPos + (colWidths[4]/2), yPosition + 8, { align: 'center' });
            xPos += colWidths[4];
            doc.text('SALDO AKHIR', xPos + (colWidths[5]/2), yPosition + 8, { align: 'center' });
            
            yPosition += rowHeight + 4;
            
            // Table data
            doc.setFont('helvetica', 'normal');
            siswaData.forEach((siswa, index) => {
                if (yPosition > pageHeight - 30) {
                    doc.addPage();
                    yPosition = margin + 10;
                }
                
                const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                const jumlahTransaksi = siswaTransaksi.length;
                
                // Row background (alternating colors)
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250); // Very light gray
                    doc.rect(margin, yPosition - 2, contentWidth, rowHeight, 'F');
                }
                
                // Row data
                xPos = margin;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                
                // NO
                doc.text((index + 1).toString(), xPos + (colWidths[0]/2), yPosition + 8, { align: 'center' });
                xPos += colWidths[0];
                
                // NAMA (truncate if too long)
                const namaDisplay = siswa.nama.length > 35 ? siswa.nama.substring(0, 32) + '...' : siswa.nama;
                doc.text(namaDisplay, xPos + 5, yPosition + 8);
                xPos += colWidths[1];
                
                // SETOR (green color)
                doc.setTextColor(39, 174, 96); // Green
                doc.setFont('helvetica', 'bold');
                doc.text(`Rp ${totalSetor.toLocaleString('id-ID')}`, xPos + colWidths[2] - 5, yPosition + 8, { align: 'right' });
                xPos += colWidths[2];
                
                // TARIK (red color)
                doc.setTextColor(231, 76, 60); // Red
                doc.text(`Rp ${totalTarik.toLocaleString('id-ID')}`, xPos + colWidths[3] - 5, yPosition + 8, { align: 'right' });
                xPos += colWidths[3];
                
                // JUMLAH TRANSAKSI (orange color)
                doc.setTextColor(230, 126, 34); // Orange
                doc.text(jumlahTransaksi.toString(), xPos + (colWidths[4]/2), yPosition + 8, { align: 'center' });
                xPos += colWidths[4];
                
                // SALDO (blue color)
                doc.setTextColor(52, 152, 219); // Blue
                doc.text(`Rp ${siswa.saldo.toLocaleString('id-ID')}`, xPos + colWidths[5] - 5, yPosition + 8, { align: 'right' });
                
                // Reset color and font
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                
                yPosition += rowHeight;
            });
            
            // Add footer with legend
            const footerY = pageHeight - 15;
            doc.setFillColor(236, 240, 241); // Light background
            doc.rect(margin, footerY - 10, contentWidth, 15, 'F');
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('KETERANGAN WARNA:', margin + 5, footerY - 5);
            
            // Legend with colors
            let legendX = margin + 50;
            doc.setTextColor(39, 174, 96); // Green
            doc.text('‚ñ† SETOR', legendX, footerY - 5);
            legendX += 30;
            
            doc.setTextColor(231, 76, 60); // Red
            doc.text('‚ñ† TARIK', legendX, footerY - 5);
            legendX += 30;
            
            doc.setTextColor(230, 126, 34); // Orange
            doc.text('‚ñ† TRANSAKSI', legendX, footerY - 5);
            legendX += 40;
            
            doc.setTextColor(52, 152, 219); // Blue
            doc.text('‚ñ† SALDO', legendX, footerY - 5);
            
            // Date generated
            doc.setTextColor(127, 140, 141);
            doc.setFont('helvetica', 'normal');
            doc.text(`Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`, pageWidth - margin - 5, footerY - 5, { align: 'right' });
            
            const fileName = `Rekap_Tabungan_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            // Show success notification
            setTimeout(() => {
                showDownloadNotification('PDF Rekap berhasil diunduh!', 'success');
            }, 500);
            
            alert('‚úÖ File PDF Rekap berhasil diunduh!\n\nüìÑ Format: A3 Landscape\nüìä Tabel rekap dengan statistik lengkap\nüìÅ Silakan cek folder Downloads Anda');
        }

        // Test download functions
        function testDownloadXLSX() {
            console.log('üß™ Testing XLSX download...');
            
            try {
                // Create simple test data
                const testData = [
                    ['TEST UNDUH XLSX'],
                    ['Nama', 'Saldo'],
                    ['Test Siswa 1', 50000],
                    ['Test Siswa 2', 75000]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(testData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Test');
                
                const fileName = `Test_XLSX_${Date.now()}.xlsx`;
                
                // Try multiple methods
                try {
                    XLSX.writeFile(wb, fileName);
                    alert('‚úÖ TEST XLSX BERHASIL! File sudah terunduh.');
                } catch (e1) {
                    console.warn('Method 1 failed, trying method 2:', e1);
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    alert('‚úÖ TEST XLSX BERHASIL dengan metode alternatif!');
                }
                
            } catch (error) {
                console.error('‚ùå Test XLSX failed:', error);
                alert(`‚ùå TEST XLSX GAGAL: ${error.message}`);
            }
        }
        
        function testDownloadXLS() {
            console.log('üß™ Testing XLS download...');
            
            try {
                const testData = [
                    ['TEST UNDUH XLS'],
                    ['Nama', 'Saldo'],
                    ['Test Siswa 1', 50000],
                    ['Test Siswa 2', 75000]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(testData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Test');
                
                const fileName = `Test_XLS_${Date.now()}.xls`;
                
                const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.ms-excel' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                alert('‚úÖ TEST XLS BERHASIL!');
                
            } catch (error) {
                console.error('‚ùå Test XLS failed:', error);
                alert(`‚ùå TEST XLS GAGAL: ${error.message}`);
            }
        }
        
        function testDownloadCSV() {
            console.log('üß™ Testing CSV download...');
            
            try {
                const testData = [
                    ['TEST UNDUH CSV'],
                    ['Nama', 'Saldo'],
                    ['Test Siswa 1', 50000],
                    ['Test Siswa 2', 75000]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(testData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Test');
                
                const fileName = `Test_CSV_${Date.now()}.csv`;
                
                const wbout = XLSX.write(wb, { bookType: 'csv', type: 'string' });
                const blob = new Blob([wbout], { type: 'text/csv' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                alert('‚úÖ TEST CSV BERHASIL!');
                
            } catch (error) {
                console.error('‚ùå Test CSV failed:', error);
                alert(`‚ùå TEST CSV GAGAL: ${error.message}`);
            }
        }

        // Excel Download Functions with same format as PDF
        function unduhRiwayatExcel() {
            console.log('üîÑ Memulai unduh riwayat Excel dengan format PDF...');
            
            // Validate XLSX library
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Library Excel tidak tersedia!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            if (siswaData.length === 0) {
                alert('‚ùå Belum ada data siswa untuk diunduh!\n\nSilakan tambah siswa terlebih dahulu di tab SISWA.');
                return;
            }
            
            let excelData = [];
            
            // Helper function to format amount in thousands
            function formatAmount(amount) {
                if (amount === 0) return '-';
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(1) + 'jt';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(0) + 'rb';
                } else {
                    return amount.toString();
                }
            }
            
            // Helper function to create daily transaction table
            function createDailyTable(monthYear = null, isAllTransactions = false) {
                let currentMonth, currentYear;
                
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    currentMonth = parseInt(month);
                    currentYear = parseInt(year);
                } else {
                    currentMonth = parseInt(bulan);
                    currentYear = parseInt(tahun);
                }
                
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                // Title for this month section
                if (isAllTransactions) {
                    excelData.push([`TRANSAKSI : ${namaBulan[currentMonth]} ${currentYear}`]);
                } else {
                    excelData.push(['RIWAYAT TRANSAKSI']);
                    excelData.push([`${namaBulan[currentMonth]} ${currentYear}`]);
                }
                
                // School info
                excelData.push(['Sekolah:', namaSekolah]);
                excelData.push(['Kelas:', kelas]);
                excelData.push(['Wali Kelas:', waliKelas]);
                excelData.push([]);
                
                // Get days in month
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                
                // Create header
                let headerRow = ['NO', 'NAMA SISWA'];
                for (let day = 1; day <= daysInMonth; day++) {
                    headerRow.push(day.toString());
                }
                headerRow.push('SETOR', 'TARIK', 'SALDO');
                excelData.push(headerRow);
                
                // Create data rows
                siswaData.forEach((siswa, index) => {
                    let row = [index + 1, siswa.nama];
                    
                    let totalSetor = 0;
                    let totalTarik = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTransactions = transaksiData.filter(t => {
                            return t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id);
                        });
                        
                        let cellContent = '-';
                        
                        if (dayTransactions.length > 0) {
                            const setorTransactions = dayTransactions.filter(t => t.jenis === 'setor');
                            const tarikTransactions = dayTransactions.filter(t => t.jenis === 'tarik');
                            
                            const daySetor = setorTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            const dayTarik = tarikTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            
                            // Add to monthly totals
                            totalSetor += daySetor;
                            totalTarik += dayTarik;
                            
                            if (daySetor > 0 && dayTarik > 0) {
                                // Both setor and tarik - show detailed format +100k/-10k
                                cellContent = `+${formatAmount(daySetor)}/-${formatAmount(dayTarik)}`;
                            } else if (daySetor > 0) {
                                // Only setor
                                cellContent = '+' + formatAmount(daySetor);
                            } else if (dayTarik > 0) {
                                // Only tarik
                                cellContent = '-' + formatAmount(dayTarik);
                            }
                        }
                        
                        row.push(cellContent);
                    }
                    
                    // Add summary columns
                    row.push(`Rp ${totalSetor.toLocaleString('id-ID')}`);
                    row.push(`Rp ${totalTarik.toLocaleString('id-ID')}`);
                    row.push(`Rp ${siswa.saldo.toLocaleString('id-ID')}`);
                    
                    excelData.push(row);
                });
                
                excelData.push([]);
            }
            
            // Main logic
            if (bulan === 'all') {
                // Get all unique months from transactions
                const uniqueMonths = [...new Set(transaksiData.map(t => {
                    const date = new Date(t.tanggal);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }))].sort();
                
                if (uniqueMonths.length === 0) {
                    excelData.push(['RIWAYAT TRANSAKSI : SEMUA TRANSAKSI']);
                    excelData.push([]);
                    excelData.push(['Belum ada transaksi yang tercatat']);
                } else {
                    excelData.push(['RIWAYAT TRANSAKSI : SEMUA TRANSAKSI']);
                    excelData.push([]);
                    
                    uniqueMonths.forEach((monthYear, index) => {
                        if (index > 0) {
                            excelData.push([]);
                        }
                        createDailyTable(monthYear, true);
                    });
                }
            } else {
                createDailyTable();
            }
            
            // Add footer with legend
            excelData.push(['KETERANGAN:']);
            excelData.push(['SETOR = + (HIJAU)']);
            excelData.push(['TARIK = - (MERAH)']);
            excelData.push(['SETOR + TARIK = +/- (KUNING)']);
            excelData.push(['Format: rb = ribu, jt = juta']);
            excelData.push([`Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`]);
            
            console.log('üìä Data Excel siap:', excelData.length, 'baris');
            
            // Create and download Excel file
            try {
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Riwayat Transaksi');
                
                const fileName = `Riwayat_Transaksi_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Try multiple download methods
                let downloadSuccess = false;
                
                try {
                    XLSX.writeFile(wb, fileName);
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan writeFile');
                } catch (writeError) {
                    console.warn('‚ö†Ô∏è writeFile gagal, mencoba metode alternatif...');
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan blob method');
                }
                
                if (downloadSuccess) {
                    alert('‚úÖ File Excel Riwayat berhasil diunduh!\n\nüìä Format: Excel dengan format sama seperti PDF\nüí∞ Format: +100k/-10k untuk setor dan tarik di hari yang sama\nüìÅ Silakan cek folder Downloads Anda');
                }
                
            } catch (error) {
                console.error('‚ùå Error dalam proses unduh:', error);
                alert(`‚ùå Gagal mengunduh file Excel!\n\nError: ${error.message}\n\nüí° Solusi:\n1. Refresh halaman (Ctrl+F5)\n2. Gunakan browser Chrome atau Firefox\n3. Coba format CSV sebagai alternatif`);
            }
        }

        function unduhRekapExcel() {
            console.log('üîÑ Memulai unduh rekap Excel dengan format PDF...');
            
            // Validate XLSX library
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Library Excel tidak tersedia!\n\nSilakan refresh halaman dan coba lagi.');
                return;
            }
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            if (siswaData.length === 0) {
                alert('‚ùå Belum ada data siswa untuk diunduh!\n\nSilakan tambah siswa terlebih dahulu di tab SISWA.');
                return;
            }
            
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            let excelData = [];
            
            // Header
            if (bulan === 'all') {
                excelData.push(['REKAP TABUNGAN SISWA - SEMUA PERIODE']);
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                excelData.push([`REKAP TABUNGAN SISWA - ${namaBulan[parseInt(bulan)]} ${tahun}`]);
            }
            
            // School info
            excelData.push([`${namaSekolah} | Kelas: ${kelas} | Wali Kelas: ${waliKelas}`]);
            excelData.push([]);
            
            // Summary statistics
            const totalSetoran = filteredTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPenarikan = filteredTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
            const saldoBersih = totalSetoran - totalPenarikan;
            const totalSiswa = siswaData.length;
            const siswaAktif = siswaData.filter(s => s.saldo > 0).length;
            
            excelData.push(['RINGKASAN:']);
            excelData.push(['TOTAL SETORAN', `Rp ${totalSetoran.toLocaleString('id-ID')}`]);
            excelData.push(['TOTAL PENARIKAN', `Rp ${totalPenarikan.toLocaleString('id-ID')}`]);
            excelData.push(['SALDO BERSIH', `Rp ${saldoBersih.toLocaleString('id-ID')}`]);
            excelData.push(['SISWA AKTIF', `${siswaAktif} / ${totalSiswa}`]);
            excelData.push([]);
            
            // Table header
            excelData.push(['NO', 'NAMA SISWA', 'TOTAL SETOR', 'TOTAL TARIK', 'JML TRANSAKSI', 'SALDO AKHIR']);
            
            // Table data
            siswaData.forEach((siswa, index) => {
                const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                const jumlahTransaksi = siswaTransaksi.length;
                
                excelData.push([
                    index + 1,
                    siswa.nama,
                    `Rp ${totalSetor.toLocaleString('id-ID')}`,
                    `Rp ${totalTarik.toLocaleString('id-ID')}`,
                    jumlahTransaksi,
                    `Rp ${siswa.saldo.toLocaleString('id-ID')}`
                ]);
            });
            
            // Footer
            excelData.push([]);
            excelData.push(['KETERANGAN:']);
            excelData.push(['SETOR = + (HIJAU)']);
            excelData.push(['TARIK = - (MERAH)']);
            excelData.push(['SETOR + TARIK = +/- (KUNING)']);
            excelData.push([`Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`]);
            
            console.log('üìä Data Excel siap:', excelData.length, 'baris');
            
            // Create and download Excel file
            try {
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Tabungan');
                
                const fileName = `Rekap_Tabungan_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Try multiple download methods
                let downloadSuccess = false;
                
                try {
                    XLSX.writeFile(wb, fileName);
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan writeFile');
                } catch (writeError) {
                    console.warn('‚ö†Ô∏è writeFile gagal, mencoba metode alternatif...');
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    downloadSuccess = true;
                    console.log('‚úÖ File berhasil diunduh dengan blob method');
                }
                
                if (downloadSuccess) {
                    alert('‚úÖ File Excel Rekap berhasil diunduh!\n\nüìä Format: Excel dengan format sama seperti PDF\nüìà Termasuk statistik dan ringkasan data\nüìÅ Silakan cek folder Downloads Anda');
                }
                
            } catch (error) {
                console.error('‚ùå Error dalam proses unduh:', error);
                alert(`‚ùå Gagal mengunduh file Excel!\n\nError: ${error.message}\n\nüí° Solusi:\n1. Refresh halaman (Ctrl+F5)\n2. Gunakan browser Chrome atau Firefox\n3. Coba format CSV sebagai alternatif`);
            }
        }

        // CSV Download Functions with same format as PDF
        function unduhRiwayatCSV() {
            // Show loading notification
            showDownloadNotification('Memproses unduhan CSV Riwayat...', 'loading');
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            let csvContent = '';
            
            // Helper function to format amount in thousands
            function formatAmount(amount) {
                if (amount === 0) return '-';
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(1) + 'jt';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(0) + 'rb';
                } else {
                    return amount.toString();
                }
            }
            
            // Helper function to create daily transaction table
            function createDailyTable(monthYear = null, isAllTransactions = false) {
                let currentMonth, currentYear;
                
                if (monthYear) {
                    const [year, month] = monthYear.split('-');
                    currentMonth = parseInt(month);
                    currentYear = parseInt(year);
                } else {
                    currentMonth = parseInt(bulan);
                    currentYear = parseInt(tahun);
                }
                
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                
                // Title for this month section
                if (isAllTransactions) {
                    csvContent += `TRANSAKSI : ${namaBulan[currentMonth]} ${currentYear}\n`;
                } else {
                    csvContent += `RIWAYAT TRANSAKSI\n`;
                    csvContent += `${namaBulan[currentMonth]} ${currentYear}\n`;
                }
                
                // School info
                csvContent += `Sekolah:,${namaSekolah}\n`;
                csvContent += `Kelas:,${kelas}\n`;
                csvContent += `Wali Kelas:,${waliKelas}\n`;
                csvContent += '\n';
                
                // Get days in month
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                
                // Create header
                let headerRow = 'NO,NAMA SISWA';
                for (let day = 1; day <= daysInMonth; day++) {
                    headerRow += `,${day}`;
                }
                headerRow += ',SETOR,TARIK,SALDO';
                csvContent += headerRow + '\n';
                
                // Create data rows
                siswaData.forEach((siswa, index) => {
                    let row = `${index + 1},${siswa.nama}`;
                    
                    let totalSetor = 0;
                    let totalTarik = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTransactions = transaksiData.filter(t => {
                            return t.tanggal === dateString && parseInt(t.siswaId) === parseInt(siswa.id);
                        });
                        
                        let cellContent = '-';
                        
                        if (dayTransactions.length > 0) {
                            const setorTransactions = dayTransactions.filter(t => t.jenis === 'setor');
                            const tarikTransactions = dayTransactions.filter(t => t.jenis === 'tarik');
                            
                            const daySetor = setorTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            const dayTarik = tarikTransactions.reduce((sum, t) => sum + t.jumlah, 0);
                            
                            // Add to monthly totals
                            totalSetor += daySetor;
                            totalTarik += dayTarik;
                            
                            if (daySetor > 0 && dayTarik > 0) {
                                // Both setor and tarik - show detailed format +100k/-10k
                                cellContent = `+${formatAmount(daySetor)}/-${formatAmount(dayTarik)}`;
                            } else if (daySetor > 0) {
                                // Only setor
                                cellContent = '+' + formatAmount(daySetor);
                            } else if (dayTarik > 0) {
                                // Only tarik
                                cellContent = '-' + formatAmount(dayTarik);
                            }
                        }
                        
                        row += `,${cellContent}`;
                    }
                    
                    // Add summary columns
                    row += `,Rp ${totalSetor.toLocaleString('id-ID')},Rp ${totalTarik.toLocaleString('id-ID')},Rp ${siswa.saldo.toLocaleString('id-ID')}`;
                    
                    csvContent += row + '\n';
                });
                
                csvContent += '\n';
            }
            
            // Main logic
            if (bulan === 'all') {
                // Get all unique months from transactions
                const uniqueMonths = [...new Set(transaksiData.map(t => {
                    const date = new Date(t.tanggal);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }))].sort();
                
                if (uniqueMonths.length === 0) {
                    csvContent += 'RIWAYAT TRANSAKSI : SEMUA TRANSAKSI\n';
                    csvContent += '\n';
                    csvContent += 'Belum ada transaksi yang tercatat\n';
                } else {
                    csvContent += 'RIWAYAT TRANSAKSI : SEMUA TRANSAKSI\n';
                    csvContent += '\n';
                    
                    uniqueMonths.forEach((monthYear, index) => {
                        if (index > 0) {
                            csvContent += '\n';
                        }
                        createDailyTable(monthYear, true);
                    });
                }
            } else {
                createDailyTable();
            }
            
            // Add footer with legend
            csvContent += 'KETERANGAN:\n';
            csvContent += 'SETOR = + (HIJAU)\n';
            csvContent += 'TARIK = - (MERAH)\n';
            csvContent += 'SETOR + TARIK = +/- (KUNING)\n';
            csvContent += 'Format: rb = ribu, jt = juta\n';
            csvContent += `Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}\n`;
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const fileName = `Riwayat_Transaksi_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            // Show success notification
            setTimeout(() => {
                showDownloadNotification('CSV Riwayat berhasil diunduh!', 'success');
            }, 500);
            
            alert('‚úÖ File CSV Riwayat berhasil diunduh!\n\nüìä Format: CSV dengan jumlah transaksi dalam angka\nüí∞ Format: +100k/-10k untuk setor dan tarik di hari yang sama\nüìÅ Silakan cek folder Downloads Anda');
        }

        function unduhRekapCSV() {
            // Show loading notification
            showDownloadNotification('Memproses unduhan CSV Rekap...', 'loading');
            
            const bulan = document.getElementById('unduhBulan').value;
            const tahun = document.getElementById('unduhTahun').value;
            
            const namaSekolah = document.getElementById('namaSekolah').value || 'Nama Sekolah';
            const kelas = document.getElementById('kelas').value || 'Kelas';
            const waliKelas = document.getElementById('waliKelas').value || 'Wali Kelas';
            
            let filteredTransaksi = transaksiData;
            
            if (bulan !== 'all' || tahun !== 'all') {
                filteredTransaksi = transaksiData.filter(t => {
                    const tDate = new Date(t.tanggal);
                    const matchBulan = bulan === 'all' || (tDate.getMonth() + 1) === parseInt(bulan);
                    const matchTahun = tahun === 'all' || tDate.getFullYear() === parseInt(tahun);
                    return matchBulan && matchTahun;
                });
            }
            
            let csvContent = '';
            
            // Header
            if (bulan === 'all') {
                csvContent += 'REKAP TABUNGAN SISWA - SEMUA PERIODE\n';
            } else {
                const namaBulan = ['', 'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
                csvContent += `REKAP TABUNGAN SISWA - ${namaBulan[parseInt(bulan)]} ${tahun}\n`;
            }
            
            // School info
            csvContent += `${namaSekolah} | Kelas: ${kelas} | Wali Kelas: ${waliKelas}\n`;
            csvContent += '\n';
            
            // Summary statistics
            const totalSetoran = filteredTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPenarikan = filteredTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
            const saldoBersih = totalSetoran - totalPenarikan;
            const totalSiswa = siswaData.length;
            const siswaAktif = siswaData.filter(s => s.saldo > 0).length;
            
            csvContent += 'RINGKASAN:\n';
            csvContent += `TOTAL SETORAN,Rp ${totalSetoran.toLocaleString('id-ID')}\n`;
            csvContent += `TOTAL PENARIKAN,Rp ${totalPenarikan.toLocaleString('id-ID')}\n`;
            csvContent += `SALDO BERSIH,Rp ${saldoBersih.toLocaleString('id-ID')}\n`;
            csvContent += `SISWA AKTIF,${siswaAktif} / ${totalSiswa}\n`;
            csvContent += '\n';
            
            // Table header
            csvContent += 'NO,NAMA SISWA,TOTAL SETOR,TOTAL TARIK,JML TRANSAKSI,SALDO AKHIR\n';
            
            // Table data
            siswaData.forEach((siswa, index) => {
                const siswaTransaksi = filteredTransaksi.filter(t => parseInt(t.siswaId) === parseInt(siswa.id));
                const totalSetor = siswaTransaksi.filter(t => t.jenis === 'setor').reduce((sum, t) => sum + t.jumlah, 0);
                const totalTarik = siswaTransaksi.filter(t => t.jenis === 'tarik').reduce((sum, t) => sum + t.jumlah, 0);
                const jumlahTransaksi = siswaTransaksi.length;
                
                csvContent += `${index + 1},"${siswa.nama}",Rp ${totalSetor.toLocaleString('id-ID')},Rp ${totalTarik.toLocaleString('id-ID')},${jumlahTransaksi},Rp ${siswa.saldo.toLocaleString('id-ID')}\n`;
            });
            
            // Footer
            csvContent += '\n';
            csvContent += 'KETERANGAN WARNA:\n';
            csvContent += 'SETOR = Hijau\n';
            csvContent += 'TARIK = Merah\n';
            csvContent += 'TRANSAKSI = Orange\n';
            csvContent += 'SALDO = Biru\n';
            csvContent += `Dibuat: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}\n`;
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const fileName = `Rekap_Tabungan_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            // Show success notification
            setTimeout(() => {
                showDownloadNotification('CSV Rekap berhasil diunduh!', 'success');
            }, 500);
            
            alert('‚úÖ File CSV Rekap berhasil diunduh!\n\nüìä Format: CSV dengan tabel rekap lengkap\nüìà Termasuk statistik dan ringkasan data\nüìÅ Silakan cek folder Downloads Anda');
        }

        // Auto-fill class function
        function autoFillKelas() {
            const kelasSekolah = document.getElementById('kelas').value.trim();
            
            if (!kelasSekolah) {
                alert('‚ùå Mohon isi kelas di Informasi Sekolah terlebih dahulu!\n\nKlik tombol edit (‚úèÔ∏è) di bagian Informasi Sekolah untuk mengisi kelas.');
                return;
            }
            
            if (siswaData.length === 0) {
                alert('‚ùå Belum ada siswa yang terdaftar!\n\nTambah siswa terlebih dahulu sebelum mengisi kelas otomatis.');
                return;
            }
            
            // Count students without class or with empty class
            const siswaKosong = siswaData.filter(siswa => !siswa.kelas || siswa.kelas.trim() === '');
            
            if (siswaKosong.length === 0) {
                alert('‚úÖ Semua siswa sudah memiliki kelas!\n\nTidak ada siswa yang perlu diisi kelasnya.');
                return;
            }
            
            const konfirmasi = confirm(`üìö ISI OTOMATIS KELAS SISWA\n\n` +
                                     `Kelas yang akan diisi: "${kelasSekolah}"\n` +
                                     `Jumlah siswa yang akan diisi: ${siswaKosong.length} siswa\n\n` +
                                     `Apakah Anda yakin ingin melanjutkan?`);
            
            if (konfirmasi) {
                // Fill class for students without class
                siswaKosong.forEach(siswa => {
                    siswa.kelas = kelasSekolah;
                });
                
                updateAllDisplays();
                triggerAutosave();
                
                alert(`‚úÖ BERHASIL!\n\nüìö Kelas "${kelasSekolah}" telah diterapkan ke ${siswaKosong.length} siswa.\n\nüë• Total siswa sekarang: ${siswaData.length}`);
            }
        }

        // Backup and restore functions
        function backupData() {
            // Show loading notification
            showDownloadNotification('Memproses backup data...', 'loading');
            
            const data = {
                siswaData: siswaData,
                transaksiData: transaksiData,
                namaSekolah: document.getElementById('namaSekolah').value,
                kelas: document.getElementById('kelas').value,
                waliKelas: document.getElementById('waliKelas').value,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `Backup_Tabungan_Siswa_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            // Show success notification
            setTimeout(() => {
                showDownloadNotification('Backup data berhasil diunduh!', 'success');
            }, 500);
            
            alert('‚úÖ Backup data berhasil diunduh!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.siswaData && data.transaksiData) {
                            siswaData = data.siswaData;
                            transaksiData = data.transaksiData;
                            
                            if (data.namaSekolah) document.getElementById('namaSekolah').value = data.namaSekolah;
                            if (data.kelas) document.getElementById('kelas').value = data.kelas;
                            if (data.waliKelas) document.getElementById('waliKelas').value = data.waliKelas;
                            
                            updateAllDisplays();
                            triggerAutosave();
                            
                            // Show success notification
                            showDownloadNotification('Data berhasil dipulihkan!', 'success');
                            
                            alert('‚úÖ Data berhasil dipulihkan!');
                        } else {
                            alert('‚ùå File backup tidak valid!');
                        }
                    } catch (error) {
                        alert('‚ùå Gagal membaca file backup!');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980660f7c5cc7156',t:'MTc1ODA4ODc3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
